<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pleb</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1220; --card:#161a2b; --pill:#0d6efd22; --accent:#7dd3fc; --muted:#a3aed0; --text:#e6e9ff; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b; --admin:#dc2626; --discord:#5865f2; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #0b0e1a, #090c17); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
    .main { display: flex; flex-direction: column; }
    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 16px; margin-bottom: 16px; }
    .title { font-size: clamp(20px, 3vw, 28px); font-weight: 700; letter-spacing: 0.3px; }
    .card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; }
    .row { display:flex; gap:12px; align-items: center; }
    .stack { display:grid; gap:12px; }
    .section { padding: 16px; border-bottom: 1px solid #1f2440; }
    .section:last-child { border-bottom: 0; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input[type="text"], input[type="password"] { width: 100%; padding: 12px 14px; border-radius: 12px; background: #0e1222; border: 1px solid #262c4f; color: var(--text); outline: none; }
    input[type="text"]::placeholder, input[type="password"]::placeholder { color: #6b7196; }
    input[type="file"] { display: none; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #2a3163; background: #1b2150; color: var(--text); font-weight: 600; cursor: pointer; transition: transform .05s ease, background .2s; }
    button:hover { background: #232a6a; }
    button:active { transform: translateY(1px); }
    button.success { background: var(--success); border-color: var(--success); color: white; }
    button.success:hover { background: #16a34a; }
    button.danger { background: var(--danger); border-color: var(--danger); color: white; }
    button.danger:hover { background: #dc2626; }
    button.warning { background: var(--warning); border-color: var(--warning); color: white; }
    button.warning:hover { background: #d97706; }
    button.active { background: var(--accent); border-color: var(--accent); color: #0f1220; }
    .btn-icon { padding: 8px; min-width: 36px; display: flex; align-items: center; justify-content: center; }
    #messages { height: min(50vh, 400px); overflow-y: auto; background: #0b0f20; padding: 8px; border-radius: 12px; border: 1px solid #1b2144; }
    .msg { display:grid; gap:4px; padding: 10px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 12px; margin: 8px; }
    .msg-admin { border-color: var(--admin); background: rgba(220, 38, 38, 0.1); }
    .msg-discord { border-color: var(--discord); background: rgba(88, 101, 242, 0.1); }
    .msg-image { max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; }
    .meta { display:flex; gap:8px; align-items:center; font-size: 12px; color: var(--muted); }
    .name { font-weight: 700; color: var(--accent); }
    .name-admin { color: var(--admin) !important; }
    .name-discord { color: var(--discord) !important; }
    .text-admin { color: #fca5a5; }
    .text-discord { color: #c7d2fe; }
    .time { opacity:.8; }
    .you { border-color: #2b375f; background: #10183a; }
    .status { font-size: 12px; color: var(--muted); padding: 4px 8px; background: var(--pill); border: 1px solid #2a3163; border-radius: 999px; }
    .discord-indicator { 
      background: var(--discord); 
      color: white; 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 10px; 
      font-weight: 600;
    }
    .vc-controls { display: grid; gap: 8px; }
    .vc-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .vc-participants { max-height: 200px; overflow-y: auto; }
    .participant { padding: 8px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .participant.speaking { border-color: var(--success); }
    .speaking-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .upload-area { position: relative; border: 2px dashed #262c4f; border-radius: 12px; padding: 20px; text-align: center; color: var(--muted); cursor: pointer; transition: all 0.3s ease; }
    .upload-area:hover { border-color: var(--accent); color: var(--accent); }
    .upload-area.dragover { border-color: var(--accent); background: rgba(125, 211, 252, 0.1); }
    .verification-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11, 14, 26, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .verification-card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; text-align: center; }
    footer { text-align:center; color:#778; font-size: 12px; margin-top: 16px; grid-column: 1 / -1; }
    
    /* Discord Integration Styles */
    .discord-status {
      background: var(--discord);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Typing indicator styles */
    #typingIndicator { 
      font-size: 12px; 
      color: var(--muted); 
      margin: 6px 12px; 
      min-height: 16px;
      font-style: italic;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    #typingIndicator.active { 
      opacity: 1; 
    }
    
    #typingIndicator::before {
      content: "üí¨ ";
    }
    
    /* GIF panel improvements */
    #gifPanel {
      margin-top: 8px;
      animation: slideDown 0.2s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .gif-search-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .gif-search-row input {
      flex: 1;
      margin-bottom: 0;
    }
    
    #gifResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .gif-item {
      aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      object-fit: cover;
      width: 100%;
      height: 100%;
    }
    
    .gif-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.3);
    }
    
    .gif-loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    .gif-error {
      text-align: center;
      padding: 20px;
      color: var(--danger);
    }
    
    .gif-empty {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    #gifBtn.active {
      background: var(--accent);
      color: #0f1220;
    }
    
    @media (max-width: 768px) {
      .wrap { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
      
      #gifResults {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Verification Screen -->
  <div id="verificationScreen" class="verification-screen">
    <div class="verification-card">
      <div class="title" style="margin-bottom: 16px;">üîí Access Required</div>
      <p>Enter the chat password to join:</p>
      
      <div class="stack">
        <div>
          <label for="passwordInput">Password</label>
          <input id="passwordInput" type="password" placeholder="Enter password..." />
        </div>
        <div>
          <label for="displayNameInput">Display Name</label>
          <input id="displayNameInput" type="text" placeholder="e.g., Onion" maxlength="20" />
        </div>
        <button id="enterChatBtn" class="success">üö™ Enter Chat</button>
      </div>
      
      <div id="errorMessage" style="color: var(--danger); margin-top: 16px; display: none;">
        ‚ùå Incorrect password. Try again.
      </div>
    </div>
  </div>

  <div class="wrap" id="mainApp" style="display: none;">
    <div class="main">
      <header>
        <div class="row" style="gap:10px">
          <div class="title">üòõ Pleb</div>
          <div id="conn" class="status" title="Connection status">‚óè Connecting‚Ä¶</div>
          <div id="discordStatus" class="discord-status" style="display: none;">Discord Connected</div>
        </div>
        <button id="clearBtn" title="Clear local data">Reset</button>
      </header>

      <div class="card">
        <div class="section">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="displayName">Display name</label>
              <input id="displayName" type="text" placeholder="e.g., Onion" maxlength="20" />
            </div>
            <button id="saveNameBtn">Save</button>
          </div>
        </div>

        <div class="section stack">
          <div id="messages" aria-live="polite" aria-label="Chat messages"></div>
          <div id="typingIndicator"></div>
          
          <div class="upload-area" id="uploadArea">
            <div>üì∏ Drag & drop images here or click to select</div>
            <input type="file" id="imageInput" accept="image/*" multiple />
          </div>
          
          <!-- GIF Panel -->
          <div id="gifPanel" class="card" style="display:none;">
            <div class="section">
              <div class="gif-search-row">
                <input id="gifSearchInput" type="text" placeholder="Search GIFs‚Ä¶">
                <button id="gifSearchBtn">üîç</button>
              </div>
            </div>
            <div class="section">
              <div id="gifResults" class="gif-loading">Loading trending GIFs...</div>
            </div>
          </div>
          
          <div class="row">
            <input id="messageInput" type="text" placeholder="Type a message and press Enter‚Ä¶" maxlength="500" />
            <button id="imageBtn" class="btn-icon" title="Upload Image">üì∑</button>
            <button id="gifBtn" class="btn-icon" title="Send GIF">üé¨</button>
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <div class="section">
          <label>Voice Chat</label>
          <div class="vc-controls">
            <button id="joinVcBtn" class="success">üé§ Join Voice Chat</button>
            <div class="vc-buttons" id="vcButtons" style="display: none;">
              <button id="muteBtn" class="btn-icon" title="Mute/Unmute">üé§</button>
              <button id="deafenBtn" class="btn-icon" title="Deafen">üîä</button>
              <button id="settingsBtn" class="btn-icon" title="Settings">‚öôÔ∏è</button>
              <button id="leaveVcBtn" class="danger btn-icon" title="Leave VC">üìû</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="participantsCard" style="display: none;">
        <div class="section">
          <label>Voice Participants (<span id="participantCount">0</span>)</label>
          <div class="vc-participants" id="participantsList"></div>
        </div>
      </div>

      <div class="card" id="settingsCard" style="display: none;">
        <div class="section">
          <label>Audio Settings</label>
          <div class="stack">
            <div>
              <label for="micSelect">Microphone</label>
              <select id="micSelect" style="width: 100%; padding: 8px; border-radius: 8px; background: #0e1222; border: 1px solid #262c4f; color: var(--text);">
                <option>Default</option>
              </select>
            </div>
            <div>
              <label for="volumeSlider">Volume: <span id="volumeValue">100%</span></label>
              <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width: 100%;" />
            </div>
            <button id="testMicBtn">Test Microphone</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      Built with Firebase Realtime Database ¬∑ Discord Integration Active ¬∑ Be nice, stay cozy ‚ú®
    </footer>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, push, serverTimestamp, onChildAdded, limitToLast, query, orderByChild, onValue, set, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // Your config
    const firebaseConfig = {
      apiKey: "AIzaSyAUhiB3d042QEfM5qWdC5qYGt7hrcqKolc",
      authDomain: "chatting-6cd81.firebaseapp.com",
      databaseURL: "https://chatting-6cd81-default-rtdb.firebaseio.com",
      projectId: "chatting-6cd81",
      storageBucket: "chatting-6cd81.firebasestorage.app",
      messagingSenderId: "584471983807",
      appId: "1:584471983807:web:b71eb2ba2a071d311b380a",
      measurementId: "G-53H0MM5V6M"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // CHANGE THIS PASSWORD TO WHATEVER YOU WANT
    const CHAT_PASSWORD = "plebous123ous";
    
    // GIF API
    const GIPHY_KEY = "bDiYI9SyxC1DGIdqZe3ZdbnFsOHJGlBm";
    
    // Discord Integration Server URL - CHANGE THIS TO YOUR SERVER URL
    const DISCORD_SERVER_URL = "https://plebious-github-io.onrender.com";

    // DOM Elements
    const verificationScreen = document.getElementById('verificationScreen');
    const mainApp = document.getElementById('mainApp');
    const passwordInput = document.getElementById('passwordInput');
    const displayNameInput = document.getElementById('displayNameInput');
    const enterChatBtn = document.getElementById('enterChatBtn');
    const errorMessage = document.getElementById('errorMessage');
    
    const nameInput = document.getElementById('displayName');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const resetBtn = document.getElementById('clearBtn');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const listEl = document.getElementById('messages');
    const connEl = document.getElementById('conn');
    const discordStatusEl = document.getElementById('discordStatus');
    const imageInput = document.getElementById('imageInput');
    const imageBtn = document.getElementById('imageBtn');
    const uploadArea = document.getElementById('uploadArea');
    const typingIndicator = document.getElementById('typingIndicator');
    
    // GIF Elements
    const gifBtn = document.getElementById('gifBtn');
    const gifPanel = document.getElementById('gifPanel');
    const gifSearchInput = document.getElementById('gifSearchInput');
    const gifSearchBtn = document.getElementById('gifSearchBtn');
    const gifResults = document.getElementById('gifResults');
    
    // Voice Chat Elements
    const joinVcBtn = document.getElementById('joinVcBtn');
    const vcButtons = document.getElementById('vcButtons');
    const muteBtn = document.getElementById('muteBtn');
    const deafenBtn = document.getElementById('deafenBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const leaveVcBtn = document.getElementById('leaveVcBtn');
    const participantsCard = document.getElementById('participantsCard');
    const participantsList = document.getElementById('participantsList');
    const participantCount = document.getElementById('participantCount');
    const settingsCard = document.getElementById('settingsCard');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const testMicBtn = document.getElementById('testMicBtn');

    // Voice Chat State
    let inVoiceChat = false;
    let isMuted = false;
    let isDeafened = false;
    let mediaStream = null;
    let userId = Math.random().toString(36).substr(2, 9);

    // Typing state
    let typingTimeout;
    let isTyping = false;
    
    // Discord connection state
    let discordConnected = false;

    // Helpers
    const STORAGE_KEY = 'pleb_chat_name';
    const VERIFIED_KEY = 'pleb_chat_verified';
    const messagesRef = ref(db, 'messages');
    const presenceRef = ref(db, '.info/connected');
    const voiceParticipantsRef = ref(db, 'voice_participants');
    const userVoiceRef = ref(db, `voice_participants/${userId}`);
    const kickedUsersRef = ref(db, 'kicked_users');
    const typingRef = ref(db, 'typing');
    const userTypingRef = ref(db, `typing/${userId}`);

    // Discord Integration Functions
    async function sendToDiscord(name, text, imageData = null) {
      if (!discordConnected) return;
      
      try {
        const response = await fetch(`${DISCORD_SERVER_URL}/send-to-discord`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name,
            text: text,
            imageData: imageData
          })
        });
        
        if (response.ok) {
          console.log('Message sent to Discord successfully');
        } else {
          console.error('Failed to send message to Discord');
        }
      } catch (error) {
        console.error('Error sending to Discord:', error);
        setDiscordStatus(false);
      }
    }

    async function checkDiscordConnection() {
      try {
        const response = await fetch(`${DISCORD_SERVER_URL}/health`);
        if (response.ok) {
          const data = await response.json();
          setDiscordStatus(data.discord === true);
          return data.discord === true;
        }
      } catch (error) {
        console.error('Discord server connection error:', error);
      }
      setDiscordStatus(false);
      return false;
    }

    function setDiscordStatus(connected) {
      discordConnected = connected;
      discordStatusEl.style.display = connected ? 'block' : 'none';
      discordStatusEl.textContent = connected ? 'Discord Connected' : 'Discord Offline';
      discordStatusEl.className = connected ? 'discord-status' : 'status';
    }

    // Password Verification
    function checkPassword() {
      const password = passwordInput.value.trim();
      const name = displayNameInput.value.trim();
      
      if (!password) {
        showError('Please enter the password');
        return;
      }
      
      if (!name) {
        showError('Please enter a display name');
        return;
      }
      
      if (password === CHAT_PASSWORD) {
        // Correct password!
        localStorage.setItem(VERIFIED_KEY, 'true');
        localStorage.setItem(STORAGE_KEY, name);
        
        // Show main app
        verificationScreen.style.display = 'none';
        mainApp.style.display = 'grid';
        nameInput.value = name;
        
        initializeMainApp();
      } else {
        showError('Incorrect password. Try again.');
        passwordInput.value = '';
        passwordInput.focus();
      }
    }

    function showError(message) {
      errorMessage.textContent = '‚ùå ' + message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }

    function checkExistingVerification() {
      const isVerified = localStorage.getItem(VERIFIED_KEY);
      const savedName = localStorage.getItem(STORAGE_KEY);
      
      if (isVerified === 'true' && savedName) {
        // Already verified, show main app
        verificationScreen.style.display = 'none';
        mainApp.style.display = 'grid';
        nameInput.value = savedName;
        initializeMainApp();
      } else {
        // Show verification screen
        passwordInput.focus();
      }
    }

    function saveName() {
      const val = (nameInput.value || '').trim();
      if (!val) return alert('Enter a display name first.');
      localStorage.setItem(STORAGE_KEY, val);
      flashStatus('Saved!');
      nameInput.blur();
    }

    function getName() {
      return (localStorage.getItem(STORAGE_KEY) || '').trim();
    }

    function flashStatus(text) {
      connEl.textContent = text;
      setTimeout(() => updateConnBadge(), 1200);
    }

    function updateConnBadge(connected) {
      if (typeof connected === 'boolean') {
        connEl.textContent = connected ? '‚óè Online' : '‚óè Offline';
        return;
      }
      connEl.textContent = connEl.textContent.includes('‚óè') ? connEl.textContent : '‚óè Online';
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        const now = new Date();
        const sameDay = d.toDateString() === now.toDateString();
        return sameDay ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : d.toLocaleString();
      } catch (_) { return '‚Ä¶'; }
    }

    function msgElement({ name, text, timestamp, imageData, isAdmin, isDiscord, discordAvatar }) {
      const me = getName();
      const root = document.createElement('div');
      root.className = 'msg' + (name === me ? ' you' : '') + (isAdmin ? ' msg-admin' : '') + (isDiscord ? ' msg-discord' : '');

      const meta = document.createElement('div');
      meta.className = 'meta';

      const nameEl = document.createElement('span');
      nameEl.className = 'name' + (isAdmin ? ' name-admin' : '') + (isDiscord ? ' name-discord' : '');
      nameEl.textContent = name || 'anon';

      const dot = document.createElement('span');
      dot.textContent = '‚Ä¢';

      const timeEl = document.createElement('span');
      timeEl.className = 'time';
      timeEl.textContent = timestamp ? formatTime(timestamp) : 'sending‚Ä¶';

      meta.append(nameEl, dot, timeEl);

      // Add Discord indicator if message is from Discord
      if (isDiscord) {
        const discordIndicator = document.createElement('span');
        discordIndicator.className = 'discord-indicator';
        discordIndicator.textContent = 'Discord';
        meta.appendChild(document.createElement('span')); // spacer
        meta.appendChild(discordIndicator);
      }

      root.appendChild(meta);

      if (text) {
        const textEl = document.createElement('div');
        textEl.className = isAdmin ? 'text-admin' : isDiscord ? 'text-discord' : '';
        textEl.textContent = text;
        root.appendChild(textEl);
      }

      if (imageData) {
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'msg-image';
        img.onclick = () => window.open(imageData, '_blank');
        root.appendChild(img);
      }

      return root;
    }

    function appendAndScroll(el) {
      listEl.appendChild(el);
      const nearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 80;
      if (nearBottom) listEl.scrollTop = listEl.scrollHeight;
    }

    // Typing indicator functions
    function updateTypingIndicator(typingData) {
      const me = getName();
      const others = Object.values(typingData || {}).filter(name => name && name !== me);
      
      console.log('Typing data:', typingData, 'Others typing:', others); // Debug log
      
      if (others.length === 0) {
        typingIndicator.textContent = '';
      } else if (others.length === 1) {
        typingIndicator.textContent = `${others[0]} is typing`;
      } else if (others.length > 5) {
        typingIndicator.textContent = `dayum that's a lotta people typing`;
      } else {
        // For 2-5 people: "User, User, and User are typing"
        const lastUser = others.pop();
        const otherUsers = others.join(', ');
        typingIndicator.textContent = `${otherUsers}, and ${lastUser} are typing`;
      }
    }

    function setTyping(typing) {
      const name = getName();
      if (!name) return;
      
      console.log('Setting typing:', typing, 'for user:', name); // Debug log
      
      if (typing && !isTyping) {
        isTyping = true;
        set(userTypingRef, name).catch(err => console.error('Typing set error:', err));
      } else if (!typing && isTyping) {
        isTyping = false;
        remove(userTypingRef).catch(err => console.error('Typing remove error:', err));
      }
    }

    function handleTypingInput() {
      const name = getName();
      if (!name) return;

      // Only trigger if there's actual content or user is actively typing
      if (msgInput.value.length > 0) {
        setTyping(true);
      }

      // Clear typing status after 2 seconds of inactivity (shorter for more responsiveness)
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        setTyping(false);
      }, 2000);
    }

    // GIF Functions
    async function fetchGifs(endpoint) {
      gifResults.innerHTML = '<div class="gif-loading">Loading GIFs...</div>';
      
      try {
        const response = await fetch(endpoint);
        const data = await response.json();
        
        gifResults.innerHTML = '';
        
        if (!data.data || data.data.length === 0) {
          gifResults.innerHTML = '<div class="gif-empty">No GIFs found. Try a different search term.</div>';
          return;
        }
        
        data.data.forEach(gif => {
          const img = document.createElement('img');
          img.src = gif.images.fixed_width_small.url;
          img.className = 'gif-item';
          img.alt = gif.title || 'GIF';
          img.onclick = () => {
            sendMessage(gif.images.original.url);
            toggleGifPanel(); // Close panel after selecting
          };
          gifResults.appendChild(img);
        });
      } catch (error) {
        console.error('Error fetching GIFs:', error);
        gifResults.innerHTML = '<div class="gif-error">Failed to load GIFs. Please try again.</div>';
      }
    }

    function loadTrendingGifs() {
      fetchGifs(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_KEY}&limit=24&rating=pg`);
    }

    function searchGifs() {
      const query = gifSearchInput.value.trim();
      if (!query) {
        loadTrendingGifs();
        return;
      }
      fetchGifs(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(query)}&limit=24&rating=pg`);
    }

    function toggleGifPanel() {
      const isVisible = gifPanel.style.display !== 'none';
      gifPanel.style.display = isVisible ? 'none' : 'block';
      gifBtn.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        loadTrendingGifs();
        gifSearchInput.focus();
      }
    }

    // Check if user is kicked
    function checkIfKicked(username, callback) {
      if (!username) {
        callback(false);
        return;
      }
      
      try {
        onValue(ref(db, `kicked_users/${username}`), (snapshot) => {
          callback(snapshot.exists());
        }, { onlyOnce: true });
      } catch (error) {
        console.error('Error checking kick status:', error);
        callback(false);
      }
    }

    async function sendMessage(imageData = null) {
      const name = getName();
      const text = (msgInput.value || '').trim();
      if (!name) return alert('Set your display name first!');
      if (!text && !imageData) return;
      
      // Check if user is kicked before sending
      try {
        const kickedSnapshot = await new Promise((resolve) => {
          onValue(ref(db, `kicked_users/${name}`), resolve, { onlyOnce: true });
        });
        
        if (kickedSnapshot.exists()) {
          alert('You have been kicked from the chat and cannot send messages.');
          msgInput.disabled = true;
          sendBtn.disabled = true;
          msgInput.placeholder = "You have been kicked from the chat";
          return;
        }
      } catch (error) {
        console.log('Could not check kick status, allowing message');
      }
      
      msgInput.value = '';
      setTyping(false); // Clear typing when sending
      msgInput.focus();

      try {
        const messageData = {
          name,
          timestamp: serverTimestamp(),
        };
        
        if (text) messageData.text = text;
        if (imageData) messageData.imageData = imageData;
        
        // Send to Firebase
        await push(messagesRef, messageData);
        
        // Send to Discord if connected
        if (discordConnected) {
          await sendToDiscord(name, text, imageData);
        }
      } catch (e) {
        console.error(e);
        alert('Failed to send. Check connection.');
      }
    }

    function handleImageUpload(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/') && file.size < 5 * 1024 * 1024) { // 5MB limit
          const reader = new FileReader();
          reader.onload = (e) => sendMessage(e.target.result);
          reader.readAsDataURL(file);
        } else {
          alert('Please select images under 5MB only.');
        }
      });
    }

    // Voice Chat Functions
    async function joinVoiceChat() {
      const name = getName();
      if (!name) return alert('Set your display name first!');
      
      // Check if user is kicked before joining voice
      try {
        const kickedSnapshot = await new Promise((resolve) => {
          onValue(ref(db, `kicked_users/${name}`), resolve, { onlyOnce: true });
        });
        
        if (kickedSnapshot.exists()) {
          alert('You have been kicked from the chat and cannot join voice chat.');
          return;
        }
      } catch (error) {
        console.log('Could not check kick status, allowing voice chat');
      }
      
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        inVoiceChat = true;
        
        // Update UI
        joinVcBtn.style.display = 'none';
        vcButtons.style.display = 'grid';
        participantsCard.style.display = 'block';
        
        // Add to Firebase
        await set(userVoiceRef, {
          name: name,
          muted: false,
          joinedAt: serverTimestamp()
        });
        
        // Clean up on disconnect
        onDisconnect(userVoiceRef).remove();
        
        flashStatus('Joined voice chat!');
      } catch (error) {
        console.error('Error joining voice chat:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }

    async function leaveVoiceChat() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      
      await remove(userVoiceRef);
      
      inVoiceChat = false;
      isMuted = false;
      isDeafened = false;
      
      // Update UI
      joinVcBtn.style.display = 'block';
      vcButtons.style.display = 'none';
      participantsCard.style.display = 'none';
      settingsCard.style.display = 'none';
      muteBtn.textContent = 'üé§';
      deafenBtn.textContent = 'üîä';
      muteBtn.classList.remove('active');
      deafenBtn.classList.remove('active');
      
      flashStatus('Left voice chat');
    }

    function toggleMute() {
      if (!inVoiceChat) return;
      
      isMuted = !isMuted;
      muteBtn.textContent = isMuted ? 'üîá' : 'üé§';
      muteBtn.classList.toggle('active', isMuted);
      
      if (mediaStream) {
        mediaStream.getAudioTracks().forEach(track => {
          track.enabled = !isMuted;
        });
      }
      
      // Update Firebase
      set(ref(db, `voice_participants/${userId}/muted`), isMuted);
    }

    function toggleDeafen() {
      isDeafened = !isDeafened;
      deafenBtn.textContent = isDeafened ? 'üîá' : 'üîä';
      deafenBtn.classList.toggle('active', isDeafened);
      
      // If deafened, also mute
      if (isDeafened && !isMuted) {
        toggleMute();
      }
    }

    function toggleSettings() {
      const isVisible = settingsCard.style.display !== 'none';
      settingsCard.style.display = isVisible ? 'none' : 'block';
    }

    function updateParticipants(participants) {
      participantsList.innerHTML = '';
      const count = Object.keys(participants).length;
      participantCount.textContent = count;
      
      Object.entries(participants).forEach(([id, data]) => {
        const div = document.createElement('div');
        div.className = 'participant';
        
        const indicator = document.createElement('div');
        indicator.className = 'speaking-indicator';
        indicator.style.visibility = data.muted ? 'hidden' : 'visible';
        
        const name = document.createElement('span');
        name.textContent = data.name || 'Anonymous';
        
        div.appendChild(indicator);
        div.appendChild(name);
        participantsList.appendChild(div);
      });
    }

    function initializeMainApp() {
      // Check Discord connection status
      checkDiscordConnection();
      
      // Periodically check Discord connection
      setInterval(checkDiscordConnection, 30000); // Check every 30 seconds
      
      // Connection badge
      onValue(presenceRef, (snap) => {
        const connected = !!snap.val();
        updateConnBadge(connected);
      });

      // Stream messages (latest 200)
      const recent = query(messagesRef, orderByChild('timestamp'), limitToLast(200));
      onChildAdded(recent, (snap) => {
        const v = snap.val() || {};
        const ts = typeof v.timestamp === 'number' ? v.timestamp : Date.now();
        appendAndScroll(msgElement({ 
          name: v.name, 
          text: v.text, 
          timestamp: ts,
          imageData: v.imageData,
          isAdmin: v.isAdmin || false,
          isDiscord: v.isDiscord || false,
          discordAvatar: v.discordAvatar
        }));
      });

      // Listen for typing indicators
      onValue(typingRef, (snapshot) => {
        updateTypingIndicator(snapshot.val());
      });

      // Listen for voice participants
      onValue(voiceParticipantsRef, (snap) => {
        const participants = snap.val() || {};
        if (inVoiceChat) {
          updateParticipants(participants);
        }
      });

      // Real-time kick monitoring
      const currentName = getName();
      if (currentName) {
        try {
          onValue(ref(db, `kicked_users/${currentName}`), (snapshot) => {
            if (snapshot.exists()) {
              // User has been kicked!
              alert('You have been kicked from the chat by an administrator.');
              
              // Disable chat functionality immediately
              msgInput.disabled = true;
              sendBtn.disabled = true;
              imageBtn.disabled = true;
              gifBtn.disabled = true;
              msgInput.placeholder = "You have been kicked from the chat";
              msgInput.style.backgroundColor = '#2d1b1b';
              
              // Clear typing status
              setTyping(false);
              
              // Leave voice chat if in it
              if (inVoiceChat) {
                leaveVoiceChat();
              }
              
              // Disable voice chat button
              joinVcBtn.disabled = true;
              joinVcBtn.textContent = '‚ùå Kicked from Chat';
              joinVcBtn.classList.add('danger');
              
              // Close GIF panel
              if (gifPanel.style.display !== 'none') {
                toggleGifPanel();
              }
              
              // Show kick message in status
              flashStatus('‚ùå Kicked');
            } else {
              // User is not kicked, ensure everything is enabled
              if (msgInput.disabled) {
                msgInput.disabled = false;
                sendBtn.disabled = false;
                imageBtn.disabled = false;
                gifBtn.disabled = false;
                msgInput.placeholder = "Type a message and press Enter‚Ä¶";
                msgInput.style.backgroundColor = '#0e1222';
                
                joinVcBtn.disabled = false;
                joinVcBtn.textContent = 'üé§ Join Voice Chat';
                joinVcBtn.classList.remove('danger');
                joinVcBtn.classList.add('success');
                
                flashStatus('‚úÖ Access Restored');
              }
            }
          });
        } catch (error) {
          console.error('Error monitoring kick status:', error);
        }
      }

      // Clean up typing status on disconnect
      onDisconnect(userTypingRef).remove();
    }

    // Event Listeners
    enterChatBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkPassword();
    });
    displayNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkPassword();
    });

    saveNameBtn.addEventListener('click', saveName);
    resetBtn.addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(VERIFIED_KEY);
      location.reload();
    });
    
    sendBtn.addEventListener('click', () => sendMessage());
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Typing indicator events
    msgInput.addEventListener('input', handleTypingInput);
    msgInput.addEventListener('focus', handleTypingInput);
    msgInput.addEventListener('blur', () => setTyping(false));

    // Image Upload Events
    imageBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', (e) => handleImageUpload(e.target.files));
    uploadArea.addEventListener('click', () => imageInput.click());
    
    // Drag and Drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleImageUpload(e.dataTransfer.files);
    });

    // GIF Events
    gifBtn.addEventListener('click', toggleGifPanel);
    gifSearchBtn.addEventListener('click', searchGifs);
    gifSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchGifs();
    });

    // Voice Chat Events
    joinVcBtn.addEventListener('click', joinVoiceChat);
    leaveVcBtn.addEventListener('click', leaveVoiceChat);
    muteBtn.addEventListener('click', toggleMute);
    deafenBtn.addEventListener('click', toggleDeafen);
    settingsBtn.addEventListener('click', toggleSettings);
    
    volumeSlider.addEventListener('input', (e) => {
      volumeValue.textContent = e.target.value + '%';
    });
    
    testMicBtn.addEventListener('click', () => {
      if (mediaStream) {
        flashStatus('Microphone working!');
      } else {
        alert('Join voice chat first to test microphone.');
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (inVoiceChat) {
        leaveVoiceChat();
      }
      setTyping(false);
    });

    // Initialize
    checkExistingVerification();
  </script>
</body>
</html>
