<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pleb</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1220; --card:#161a2b; --pill:#0d6efd22; --accent:#7dd3fc; --muted:#a3aed0; --text:#e6e9ff; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #0b0e1a, #090c17); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
    .main { display: flex; flex-direction: column; }
    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 16px; margin-bottom: 16px; }
    .title { font-size: clamp(20px, 3vw, 28px); font-weight: 700; letter-spacing: 0.3px; }
    .card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; }
    .row { display:flex; gap:12px; align-items: center; }
    .stack { display:grid; gap:12px; }
    .section { padding: 16px; border-bottom: 1px solid #1f2440; }
    .section:last-child { border-bottom: 0; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input[type="text"] { width: 100%; padding: 12px 14px; border-radius: 12px; background: #0e1222; border: 1px solid #262c4f; color: var(--text); outline: none; }
    input[type="text"]::placeholder { color: #6b7196; }
    input[type="file"] { display: none; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #2a3163; background: #1b2150; color: var(--text); font-weight: 600; cursor: pointer; transition: transform .05s ease, background .2s; }
    button:hover { background: #232a6a; }
    button:active { transform: translateY(1px); }
    button.success { background: var(--success); border-color: var(--success); color: white; }
    button.success:hover { background: #16a34a; }
    button.danger { background: var(--danger); border-color: var(--danger); color: white; }
    button.danger:hover { background: #dc2626; }
    button.warning { background: var(--warning); border-color: var(--warning); color: white; }
    button.warning:hover { background: #d97706; }
    button.active { background: var(--accent); border-color: var(--accent); color: #0f1220; }
    .btn-icon { padding: 8px; min-width: 36px; display: flex; align-items: center; justify-content: center; }
    #messages { height: min(50vh, 400px); overflow-y: auto; background: #0b0f20; padding: 8px; border-radius: 12px; border: 1px solid #1b2144; }
    .msg { display:grid; gap:4px; padding: 10px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 12px; margin: 8px; }
    .msg-image { max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; }
    .meta { display:flex; gap:8px; align-items:center; font-size: 12px; color: var(--muted); }
    .name { font-weight: 700; color: var(--accent); }
    .time { opacity:.8; }
    .you { border-color: #2b375f; background: #10183a; }
    .status { font-size: 12px; color: var(--muted); padding: 4px 8px; background: var(--pill); border: 1px solid #2a3163; border-radius: 999px; }
    .vc-controls { display: grid; gap: 8px; }
    .vc-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .vc-participants { max-height: 200px; overflow-y: auto; }
    .participant { padding: 8px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .participant.speaking { border-color: var(--success); }
    .speaking-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .upload-area { position: relative; border: 2px dashed #262c4f; border-radius: 12px; padding: 20px; text-align: center; color: var(--muted); cursor: pointer; transition: all 0.3s ease; }
    .upload-area:hover { border-color: var(--accent); color: var(--accent); }
    .upload-area.dragover { border-color: var(--accent); background: rgba(125, 211, 252, 0.1); }
    .verification-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11, 14, 26, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .verification-card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; text-align: center; }
    .verification-status { padding: 12px 16px; border-radius: 12px; margin: 16px 0; font-weight: 600; }
    .verification-status.pending { background: rgba(245, 158, 11, 0.2); border: 1px solid var(--warning); color: var(--warning); }
    .verification-status.denied { background: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger); color: var(--danger); }
    footer { text-align:center; color:#778; font-size: 12px; margin-top: 16px; grid-column: 1 / -1; }
    
    @media (max-width: 768px) {
      .wrap { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
    }
  </style>
</head>
<body>
  <!-- Verification Screen -->
  <div id="verificationScreen" class="verification-screen">
    <div class="verification-card">
      <div class="title" style="margin-bottom: 16px;">üîí Verification Required</div>
      
      <div id="verificationStep1">
        <p>To join the chat, please enter your display name and request access:</p>
        <div class="stack">
          <div>
            <label for="verifyName">Display Name</label>
            <input id="verifyName" type="text" placeholder="e.g., Onion" maxlength="20" />
          </div>
          <button id="requestAccessBtn" class="warning">Request Access</button>
        </div>
      </div>
      
      <div id="verificationStep2" style="display: none;">
        <div id="verificationStatus" class="verification-status pending">
          ‚è≥ Waiting for admin approval...
        </div>
        <p>Your request has been sent to the admin. Please wait for approval.</p>
        <button id="checkStatusBtn">Check Status</button>
        <button id="cancelRequestBtn" class="danger" style="margin-left: 8px;">Cancel Request</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="mainApp" style="display: none;">
    <div class="main">
      <header>
        <div class="row" style="gap:10px">
          <div class="title">üòõ Pleb</div>
          <div id="conn" class="status" title="Connection status">‚Ä¢ Connecting‚Ä¶</div>
        </div>
        <button id="clearBtn" title="Clear local name only">Reset Name</button>
      </header>

      <div class="card">
        <div class="section">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="displayName">Display name</label>
              <input id="displayName" type="text" placeholder="e.g., Onion" maxlength="20" />
            </div>
            <button id="saveNameBtn">Save</button>
          </div>
        </div>

        <div class="section stack">
          <div id="messages" aria-live="polite" aria-label="Chat messages"></div>
          
          <div class="upload-area" id="uploadArea">
            <div>üì∏ Drag & drop images here or click to select</div>
            <input type="file" id="imageInput" accept="image/*" multiple />
          </div>
          
          <div class="row">
            <input id="messageInput" type="text" placeholder="Type a message and press Enter‚Ä¶" maxlength="500" />
            <button id="imageBtn" class="btn-icon" title="Upload Image">üì∑</button>
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <div class="section">
          <label>Voice Chat</label>
          <div class="vc-controls">
            <button id="joinVcBtn" class="success">üé§ Join Voice Chat</button>
            <div class="vc-buttons" id="vcButtons" style="display: none;">
              <button id="muteBtn" class="btn-icon" title="Mute/Unmute">üé§</button>
              <button id="deafenBtn" class="btn-icon" title="Deafen">üîä</button>
              <button id="settingsBtn" class="btn-icon" title="Settings">‚öôÔ∏è</button>
              <button id="leaveVcBtn" class="danger btn-icon" title="Leave VC">üìû</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="participantsCard" style="display: none;">
        <div class="section">
          <label>Voice Participants (<span id="participantCount">0</span>)</label>
          <div class="vc-participants" id="participantsList"></div>
        </div>
      </div>

      <div class="card" id="settingsCard" style="display: none;">
        <div class="section">
          <label>Audio Settings</label>
          <div class="stack">
            <div>
              <label for="micSelect">Microphone</label>
              <select id="micSelect" style="width: 100%; padding: 8px; border-radius: 8px; background: #0e1222; border: 1px solid #262c4f; color: var(--text);">
                <option>Default</option>
              </select>
            </div>
            <div>
              <label for="volumeSlider">Volume: <span id="volumeValue">100%</span></label>
              <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width: 100%;" />
            </div>
            <button id="testMicBtn">Test Microphone</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      Built with Firebase Realtime Database ¬∑ Be nice, stay cozy ‚ú®
    </footer>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // --- Firebase SDKs (v10+) ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, push, serverTimestamp, onChildAdded, limitToLast, query, orderByChild, onValue, set, remove, get, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

    // Your config (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyAUhiB3d042QEfM5qWdC5qYGt7hrcqKolc",
      authDomain: "chatting-6cd81.firebaseapp.com",
      databaseURL: "https://chatting-6cd81-default-rtdb.firebaseio.com",
      projectId: "chatting-6cd81",
      storageBucket: "chatting-6cd81.firebasestorage.app",
      messagingSenderId: "584471983807",
      appId: "1:584471983807:web:b71eb2ba2a071d311b380a",
      measurementId: "G-53H0MM5V6M"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const verificationScreen = document.getElementById('verificationScreen');
    const mainApp = document.getElementById('mainApp');
    const verifyNameInput = document.getElementById('verifyName');
    const requestAccessBtn = document.getElementById('requestAccessBtn');
    const verificationStep1 = document.getElementById('verificationStep1');
    const verificationStep2 = document.getElementById('verificationStep2');
    const verificationStatus = document.getElementById('verificationStatus');
    const checkStatusBtn = document.getElementById('checkStatusBtn');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    
    const nameInput = document.getElementById('displayName');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const resetBtn = document.getElementById('clearBtn');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const listEl = document.getElementById('messages');
    const connEl = document.getElementById('conn');
    const imageInput = document.getElementById('imageInput');
    const imageBtn = document.getElementById('imageBtn');
    const uploadArea = document.getElementById('uploadArea');
    
    // Voice Chat Elements
    const joinVcBtn = document.getElementById('joinVcBtn');
    const vcButtons = document.getElementById('vcButtons');
    const muteBtn = document.getElementById('muteBtn');
    const deafenBtn = document.getElementById('deafenBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const leaveVcBtn = document.getElementById('leaveVcBtn');
    const participantsCard = document.getElementById('participantsCard');
    const participantsList = document.getElementById('participantsList');
    const participantCount = document.getElementById('participantCount');
    const settingsCard = document.getElementById('settingsCard');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const testMicBtn = document.getElementById('testMicBtn');

    // Voice Chat State
    let inVoiceChat = false;
    let isMuted = false;
    let isDeafened = false;
    let mediaStream = null;
    let userId = Math.random().toString(36).substr(2, 9);
    let userToken = null;

    // Helpers
    const STORAGE_KEY = 'protogen_chat_name';
    const TOKEN_KEY = 'protogen_chat_token';
    const messagesRef = ref(db, 'messages');
    const presenceRef = ref(db, '.info/connected');
    const voiceParticipantsRef = ref(db, 'voice_participants');
    const userVoiceRef = ref(db, `voice_participants/${userId}`);
    const verificationRequestsRef = ref(db, 'verification_requests');
    const verifiedUsersRef = ref(db, 'verified_users');

    // Verification Functions
    async function requestAccess() {
      const name = verifyNameInput.value.trim();
      if (!name) return alert('Please enter a display name');
      
      try {
        // Generate a unique request ID
        const requestId = Math.random().toString(36).substr(2, 15);
        
        await set(ref(db, `verification_requests/${requestId}`), {
          name: name,
          userId: userId,
          requestedAt: serverTimestamp(),
          status: 'pending'
        });
        
        // Store the request ID locally
        localStorage.setItem('verification_request_id', requestId);
        
        // Switch to step 2
        verificationStep1.style.display = 'none';
        verificationStep2.style.display = 'block';
        
        // Start listening for status updates
        listenForVerificationStatus(requestId);
        
      } catch (error) {
        console.error('Error requesting access:', error);
        alert('Failed to send request. Please try again.');
      }
    }

    function listenForVerificationStatus(requestId) {
      const requestRef = ref(db, `verification_requests/${requestId}`);
      onValue(requestRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        if (data.status === 'approved') {
          // Generate and store user token
          userToken = Math.random().toString(36).substr(2, 20);
          localStorage.setItem(TOKEN_KEY, userToken);
          localStorage.setItem(STORAGE_KEY, data.name);
          
          // Add to verified users
          set(ref(db, `verified_users/${userId}`), {
            name: data.name,
            token: userToken,
            verifiedAt: serverTimestamp()
          });
          
          // Clean up request
          remove(requestRef);
          localStorage.removeItem('verification_request_id');
          
          // Show main app
          verificationScreen.style.display = 'none';
          mainApp.style.display = 'grid';
          nameInput.value = data.name;
          initializeMainApp();
          
        } else if (data.status === 'denied') {
          verificationStatus.className = 'verification-status denied';
          verificationStatus.innerHTML = '‚ùå Access denied';
          setTimeout(() => {
            // Reset to step 1
            verificationStep2.style.display = 'none';
            verificationStep1.style.display = 'block';
            verificationStatus.className = 'verification-status pending';
            verificationStatus.innerHTML = '‚è≥ Waiting for admin approval...';
            // Clean up
            remove(requestRef);
            localStorage.removeItem('verification_request_id');
          }, 3000);
        }
      });
    }

    async function checkVerificationStatus() {
      const requestId = localStorage.getItem('verification_request_id');
      if (!requestId) return;
      
      try {
        const snapshot = await get(ref(db, `verification_requests/${requestId}`));
        const data = snapshot.val();
        
        if (!data) {
          // Request no longer exists, reset
          localStorage.removeItem('verification_request_id');
          verificationStep2.style.display = 'none';
          verificationStep1.style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking status:', error);
      }
    }

    function cancelRequest() {
      const requestId = localStorage.getItem('verification_request_id');
      if (requestId) {
        remove(ref(db, `verification_requests/${requestId}`));
        localStorage.removeItem('verification_request_id');
      }
      
      verificationStep2.style.display = 'none';
      verificationStep1.style.display = 'block';
      verifyNameInput.value = '';
    }

    async function checkExistingVerification() {
      userToken = localStorage.getItem(TOKEN_KEY);
      const savedName = localStorage.getItem(STORAGE_KEY);
      
      if (userToken && savedName) {
        // Check if still verified
        try {
          const snapshot = await get(ref(db, `verified_users/${userId}`));
          if (snapshot.exists() && snapshot.val().token === userToken) {
            // Still verified, show main app
            verificationScreen.style.display = 'none';
            mainApp.style.display = 'grid';
            nameInput.value = savedName;
            initializeMainApp();
            return;
          }
        } catch (error) {
          console.error('Error checking verification:', error);
        }
      }
      
      // Check for pending request
      const requestId = localStorage.getItem('verification_request_id');
      if (requestId) {
        try {
          const snapshot = await get(ref(db, `verification_requests/${requestId}`));
          if (snapshot.exists()) {
            const data = snapshot.val();
            verifyNameInput.value = data.name;
            verificationStep1.style.display = 'none';
            verificationStep2.style.display = 'block';
            listenForVerificationStatus(requestId);
            return;
          } else {
            localStorage.removeItem('verification_request_id');
          }
        } catch (error) {
          console.error('Error checking pending request:', error);
        }
      }
    }

    function saveName() {
      const val = (nameInput.value || '').trim();
      if (!val) return alert('Enter a display name first.');
      localStorage.setItem(STORAGE_KEY, val);
      flashStatus('Saved!');
      nameInput.blur();
    }

    function getName() {
      return (localStorage.getItem(STORAGE_KEY) || '').trim();
    }

    function flashStatus(text) {
      connEl.textContent = text;
      setTimeout(() => updateConnBadge(), 1200);
    }

    function updateConnBadge(connected) {
      if (typeof connected === 'boolean') {
        connEl.textContent = connected ? '‚Ä¢ Online' : '‚Ä¢ Offline';
        return;
      }
      connEl.textContent = connEl.textContent.includes('‚Ä¢') ? connEl.textContent : '‚Ä¢ Online';
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        const now = new Date();
        const sameDay = d.toDateString() === now.toDateString();
        return sameDay ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : d.toLocaleString();
      } catch (_) { return '‚Ä¶'; }
    }

    function msgElement({ name, text, timestamp, imageData }) {
      const me = getName();
      const root = document.createElement('div');
      root.className = 'msg' + (name === me ? ' you' : '');

      const meta = document.createElement('div');
      meta.className = 'meta';

      const nameEl = document.createElement('span');
      nameEl.className = 'name';
      nameEl.textContent = name || 'anon';

      const dot = document.createElement('span');
      dot.textContent = '‚Ä¢';

      const timeEl = document.createElement('span');
      timeEl.className = 'time';
      timeEl.textContent = timestamp ? formatTime(timestamp) : 'sending‚Ä¶';

      meta.append(nameEl, dot, timeEl);
      root.appendChild(meta);

      if (text) {
        const textEl = document.createElement('div');
        textEl.textContent = text;
        root.appendChild(textEl);
      }

      if (imageData) {
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'msg-image';
        img.onclick = () => window.open(imageData, '_blank');
        root.appendChild(img);
      }

      return root;
    }

    function appendAndScroll(el) {
      listEl.appendChild(el);
      const nearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 80;
      if (nearBottom) listEl.scrollTop = listEl.scrollHeight;
    }

    async function sendMessage(imageData = null) {
      if (!userToken) return alert('Not verified!');
      
      const name = getName();
      const text = (msgInput.value || '').trim();
      if (!name) return alert('Set your display name first!');
      if (!text && !imageData) return;
      
      msgInput.value = '';
      msgInput.focus();

      try {
        const messageData = {
          name,
          timestamp: serverTimestamp(),
          userId: userId,
          token: userToken
        };
        
        if (text) messageData.text = text;
        if (imageData) messageData.imageData = imageData;
        
        await push(messagesRef, messageData);
      } catch (e) {
        console.error(e);
        alert('Failed to send. Check your Firebase rules.');
      }
    }

    function handleImageUpload(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/') && file.size < 5 * 1024 * 1024) { // 5MB limit
          const reader = new FileReader();
          reader.onload = (e) => sendMessage(e.target.result);
          reader.readAsDataURL(file);
        } else {
          alert('Please select images under 5MB only.');
        }
      });
    }

    // Voice Chat Functions
    async function joinVoiceChat() {
      if (!userToken) return alert('Not verified!');
      
      const name = getName();
      if (!name) return alert('Set your display name first!');
      
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        inVoiceChat = true;
        
        // Update UI
        joinVcBtn.style.display = 'none';
        vcButtons.style.display = 'grid';
        participantsCard.style.display = 'block';
        
        // Add to Firebase
        await set(userVoiceRef, {
          name: name,
          muted: false,
          joinedAt: serverTimestamp(),
          token: userToken
        });
        
        // Clean up on disconnect
        onDisconnect(userVoiceRef).remove();
        
        flashStatus('Joined voice chat!');
      } catch (error) {
        console.error('Error joining voice chat:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }

    async function leaveVoiceChat() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      
      await remove(userVoiceRef);
      
      inVoiceChat = false;
      isMuted = false;
      isDeafened = false;
      
      // Update UI
      joinVcBtn.style.display = 'block';
      vcButtons.style.display = 'none';
      participantsCard.style.display = 'none';
      settingsCard.style.display = 'none';
      muteBtn.textContent = 'üé§';
      deafenBtn.textContent = 'üîä';
      muteBtn.classList.remove('active');
      deafenBtn.classList.remove('active');
      
      flashStatus('Left voice chat');
    }

    function toggleMute() {
      if (!inVoiceChat) return;
      
      isMuted = !isMuted;
      muteBtn.textContent = isMuted ? 'üîá' : 'üé§';
      muteBtn.classList.toggle('active', isMuted);
      
      if (mediaStream) {
        mediaStream.getAudioTracks().forEach(track => {
          track.enabled = !isMuted;
        });
      }
      
      // Update Firebase
      set(ref(db, `voice_participants/${userId}/muted`), isMuted);
    }

    function toggleDeafen() {
      isDeafened = !isDeafened;
      deafenBtn.textContent = isDeafened ? 'üîá' : 'üîä';
      deafenBtn.classList.toggle('active', isDeafened);
      
      // If deafened, also mute
      if (isDeafened && !isMuted) {
        toggleMute();
      }
    }

    function toggleSettings() {
      const isVisible = settingsCard.style.display !== 'none';
      settingsCard.style.display = isVisible ? 'none' : 'block';
    }

    function updateParticipants(participants) {
      participantsList.innerHTML = '';
      const count = Object.keys(participants).length;
      participantCount.textContent = count;
      
      Object.entries(participants).forEach(([id, data]) => {
        const div = document.createElement('div');
        div.className = 'participant';
        
        const indicator = document.createElement('div');
        indicator.className = 'speaking-indicator';
        indicator.style.visibility = data.muted ? 'hidden' : 'visible';
        
        const name = document.createElement('span');
        name.textContent = data.name || 'Anonymous';
        
        div.appendChild(indicator);
        div.appendChild(name);
        participantsList.appendChild(div);
      });
    }

    function initializeMainApp() {
      // Connection badge
      onValue(presenceRef, (snap) => {
        const connected = !!snap.val();
        updateConnBadge(connected);
      });

      // Stream messages (latest 200)
      const recent = query(messagesRef, orderByChild('timestamp'), limitToLast(200));
      onChildAdded(recent, (snap) => {
        const v = snap.val() || {};
        const ts = typeof v.timestamp === 'number' ? v.timestamp : Date.now();
        appendAndScroll(msgElement({ 
          name: v.name, 
          text: v.text, 
          timestamp: ts,
          imageData: v.imageData 
        }));
      });

      // Listen for voice participants
      onValue(voiceParticipantsRef, (snap) => {
        const participants = snap.val() || {};
        if (inVoiceChat) {
          updateParticipants(participants);
        }
      });
    }

    // Event Listeners for verification
    requestAccessBtn.addEventListener('click', requestAccess);
    checkStatusBtn.addEventListener('click', checkVerificationStatus);
    cancelRequestBtn.addEventListener('click', cancelRequest);
    
    verifyNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        requestAccess();
      }
    });

    // Event Listeners for main app
    saveNameBtn.addEventListener('click', saveName);
    resetBtn.addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(TOKEN_KEY);
      nameInput.value = '';
      flashStatus('Name cleared');
      nameInput.focus();
    });
    
    sendBtn.addEventListener('click', () => sendMessage());
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Image Upload Events
    imageBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', (e) => handleImageUpload(e.target.files));
    uploadArea.addEventListener('click', () => imageInput.click());
    
    // Drag and Drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleImageUpload(e.dataTransfer.files);
    });

    // Voice Chat Events
    joinVcBtn.addEventListener('click', joinVoiceChat);
    leaveVcBtn.addEventListener('click', leaveVoiceChat);
    muteBtn.addEventListener('click', toggleMute);
    deafenBtn.addEventListener('click', toggleDeafen);
    settingsBtn.addEventListener('click', toggleSettings);
    
    volumeSlider.addEventListener('input', (e) => {
      volumeValue.textContent = e.target.value + '%';
    });
    
    testMicBtn.addEventListener('click', () => {
      if (mediaStream) {
        flashStatus('Microphone working!');
      } else {
        alert('Join voice chat first to test microphone.');
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (inVoiceChat) {
        leaveVoiceChat();
      }
    });

    // Initialize the app
    checkExistingVerification();
