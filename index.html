<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pleb</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f1220; --card:#161a2b; --pill:#0d6efd22; --accent:#7dd3fc; --muted:#a3aed0; --text:#e6e9ff; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b; --admin:#dc2626; --discord:#5865f2; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #0b0e1a, #090c17); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
    .main { display: flex; flex-direction: column; }
    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 16px; margin-bottom: 16px; }
    .title { font-size: clamp(20px, 3vw, 28px); font-weight: 700; letter-spacing: 0.3px; }
    .card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; }
    .row { display:flex; gap:12px; align-items: center; }
    .stack { display:grid; gap:12px; }
    .section { padding: 16px; border-bottom: 1px solid #1f2440; }
    .section:last-child { border-bottom: 0; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input[type="text"], input[type="password"], input[type="number"], select { width: 100%; padding: 12px 14px; border-radius: 12px; background: #0e1222; border: 1px solid #262c4f; color: var(--text); outline: none; }
    input[type="text"]::placeholder, input[type="password"]::placeholder { color: #6b7196; }
    input[type="file"] { display: none; }
    input[type="range"] { width: 100%; accent-color: var(--accent); }
    input[type="checkbox"] { accent-color: var(--accent); }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #2a3163; background: #1b2150; color: var(--text); font-weight: 600; cursor: pointer; transition: transform .05s ease, background .2s; }
    button:hover { background: #232a6a; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.success { background: var(--success); border-color: var(--success); color: white; }
    button.success:hover { background: #16a34a; }
    button.danger { background: var(--danger); border-color: var(--danger); color: white; }
    button.danger:hover { background: #dc2626; }
    button.warning { background: var(--warning); border-color: var(--warning); color: white; }
    button.warning:hover { background: #d97706; }
    button.active { background: var(--accent); border-color: var(--accent); color: #0f1220; }
    .btn-icon { padding: 8px; min-width: 36px; display: flex; align-items: center; justify-content: center; }
    #messages { height: min(50vh, 400px); overflow-y: auto; background: #0b0f20; padding: 8px; border-radius: 12px; border: 1px solid #1b2144; position: relative; }
    .msg { display:grid; gap:4px; padding: 10px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 12px; margin: 8px; position: relative; }
    .msg.compact { padding: 6px 8px; margin: 4px; }
    .msg-admin { border-color: var(--admin); background: rgba(220, 38, 38, 0.1); }
    .msg-discord { border-color: var(--discord); background: rgba(88, 101, 242, 0.1); }
    .msg-image { max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; }
    .msg-reply-button { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; padding: 4px 8px; font-size: 10px; }
    .msg:hover .msg-reply-button { opacity: 1; }
    .msg-reply-to { font-size: 11px; color: var(--muted); background: #1a1f3a; padding: 4px 8px; border-radius: 6px; margin-bottom: 4px; border-left: 2px solid var(--accent); }
    .meta { display:flex; gap:8px; align-items:center; font-size: 12px; color: var(--muted); }
    .name { font-weight: 700; color: var(--accent); cursor: pointer; }
    .name-admin { color: var(--admin) !important; }
    .name-discord { color: var(--discord) !important; }
    .text-admin { color: #fca5a5; }
    .text-discord { color: #c7d2fe; }
    .time { opacity:.8; }
    .you { border-color: #2b375f; background: #10183a; }
    .status { font-size: 12px; color: var(--muted); padding: 4px 8px; background: var(--pill); border: 1px solid #2a3163; border-radius: 999px; }
    .discord-indicator { 
      background: var(--discord); 
      color: white; 
      padding: 2px 6px; 
      border-radius: 4px; 
      font-size: 10px; 
      font-weight: 600;
    }
    .vc-controls { display: grid; gap: 8px; }
    .vc-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .vc-participants { max-height: 200px; overflow-y: auto; }
    .participant { padding: 8px 12px; background: #0e1329; border: 1px solid #20264a; border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .participant.speaking { border-color: var(--success); }
    .speaking-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .upload-area { position: relative; border: 2px dashed #262c4f; border-radius: 12px; padding: 20px; text-align: center; color: var(--muted); cursor: pointer; transition: all 0.3s ease; }
    .upload-area:hover { border-color: var(--accent); color: var(--accent); }
    .upload-area.dragover { border-color: var(--accent); background: rgba(125, 211, 252, 0.1); }
    .verification-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11, 14, 26, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .verification-card { background: var(--card); border: 1px solid #1f2440; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; text-align: center; }
    footer { text-align:center; color:#778; font-size: 12px; margin-top: 16px; grid-column: 1 / -1; }
    
    /* Discord Integration Styles */
    .discord-status {
      background: var(--discord);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Typing indicator styles */
    #typingIndicator { 
      font-size: 12px; 
      color: var(--muted); 
      margin: 6px 12px; 
      min-height: 16px;
      font-style: italic;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    #typingIndicator.active { 
      opacity: 1; 
    }
    
    #typingIndicator::before {
      content: "💬 ";
    }
    
    /* GIF panel improvements */
    #gifPanel {
      margin-top: 8px;
      animation: slideDown 0.2s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .gif-search-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .gif-search-row input {
      flex: 1;
      margin-bottom: 0;
    }
    
    #gifResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .gif-item {
      aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      object-fit: cover;
      width: 100%;
      height: 100%;
    }
    
    .gif-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(125, 211, 252, 0.3);
    }
    
    .gif-loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    .gif-error {
      text-align: center;
      padding: 20px;
      color: var(--danger);
    }
    
    .gif-empty {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    #gifBtn.active {
      background: var(--accent);
      color: #0f1220;
    }
    
    /* Emoji Picker Styles */
    #emojiPanel {
      position: absolute;
      bottom: 60px;
      right: 0;
      background: var(--card);
      border: 1px solid #1f2440;
      border-radius: 12px;
      padding: 12px;
      max-width: 320px;
      width: 90vw;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      animation: slideUp 0.2s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-search {
      width: 100%;
      margin-bottom: 8px;
      font-size: 12px;
      padding: 8px 10px;
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }
    
    .emoji-item {
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: background 0.1s ease;
      font-size: 18px;
      user-select: none;
    }
    
    .emoji-item:hover {
      background: rgba(125, 211, 252, 0.2);
    }
    
    #emojiBtn.active {
      background: var(--accent);
      color: #0f1220;
    }
    
    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      gap: 4px;
      background: #0e1222;
      border-radius: 8px;
      padding: 2px;
    }
    
    .theme-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .theme-btn.active {
      background: var(--accent);
      color: #0f1220;
    }
    
    /* Light theme */
    [data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --pill: #e2e8f022;
      --accent: #0ea5e9;
      --muted: #64748b;
      --text: #1e293b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    
    [data-theme="light"] body {
      background: linear-gradient(180deg, #f8fafc, #e2e8f0);
    }
    
    [data-theme="light"] input, [data-theme="light"] select {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    [data-theme="light"] #messages {
      background: #f8fafc;
      border-color: #e2e8f0;
    }
    
    [data-theme="light"] .msg {
      background: #ffffff;
      border-color: #e2e8f0;
    }
    
    [data-theme="light"] .theme-toggle {
      background: #f1f5f9;
    }
    
    /* Message Search */
    .search-results {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 50;
      padding: 8px;
      border-radius: 12px;
    }
    
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .close-search {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 10px;
    }
    
    /* Auto-scroll button */
    .scroll-to-bottom {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: var(--accent);
      color: #0f1220;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .scroll-to-bottom:hover {
      transform: scale(1.1);
    }
    
    .scroll-to-bottom.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    /* Online users indicator */
    .online-users {
      font-size: 10px;
      color: var(--success);
      padding: 2px 6px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 4px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    @media (max-width: 768px) {
      .wrap { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
      
      #gifResults {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 6px;
      }
      
      #emojiPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 12px 12px 0 0;
        max-width: none;
        width: 100%;
      }
      
      .emoji-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Verification Screen -->
  <div id="verificationScreen" class="verification-screen">
    <div class="verification-card">
      <div class="title" style="margin-bottom: 16px;">🔒 Access Required</div>
      <p>Enter the chat password to join:</p>
      
      <div class="stack">
        <div>
          <label for="passwordInput">Password</label>
          <input id="passwordInput" type="password" placeholder="Enter password..." />
        </div>
        <div>
          <label for="displayNameInput">Display Name</label>
          <input id="displayNameInput" type="text" placeholder="e.g., Onion" maxlength="20" />
        </div>
        <button id="enterChatBtn" class="success">🚪 Enter Chat</button>
        <p>Be nice, No spamming, and No teachers.</p>
      </div>
      
      <div id="errorMessage" style="color: var(--danger); margin-top: 16px; display: none;">
        ❌ Incorrect password. Try again.
      </div>
    </div>
  </div>

<div class="wrap" id="mainApp" style="display: none;">
  <div class="main">
    <header>
    <div class="row" style="gap:10px">
      <div class="title">😛 Pleb</div>
      <div id="conn" class="status" title="Connection status">● Connecting…</div>
      <div id="onlineUsers" class="online-users" style="display: none;"></div>
      <div id="discordStatus" class="discord-status" style="display: none;">Discord Connected</div>
    </div>
    <div class="row" style="gap:8px">
      <div class="theme-toggle">
        <button id="darkBtn" class="theme-btn active">🌙</button>
        <button id="lightBtn" class="theme-btn">☀️</button>
      </div>
    <!-- Reset button removed -->
    </div>
  </header>

      <div class="card">
        <div class="section">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="displayName">Display name</label>
              <input id="displayName" type="text" placeholder="e.g., Onion" maxlength="20" />
            </div>
            <button id="saveNameBtn">Save</button>
          </div>
        </div>

        <div class="section">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="searchMessages">Search Messages</label>
              <input id="searchMessages" type="text" placeholder="Search chat history..." />
            </div>
            <button id="searchBtn">🔍</button>
          </div>
        </div>

        <div class="section stack">
          <div id="messages" aria-live="polite" aria-label="Chat messages">
            <button id="scrollToBottom" class="scroll-to-bottom hidden">⬇️</button>
          </div>
          <div id="typingIndicator"></div>
          
          <div class="upload-area" id="uploadArea">
            <div>📸 Drag & drop images here or click to select</div>
            <input type="file" id="imageInput" accept="image/*" multiple />
          </div>
          
          <!-- GIF Panel -->
          <div id="gifPanel" class="card" style="display:none;">
            <div class="section">
              <div class="gif-search-row">
                <input id="gifSearchInput" type="text" placeholder="Search GIFs…">
                <button id="gifSearchBtn">🔍</button>
              </div>
            </div>
            <div class="section">
              <div id="gifResults" class="gif-loading">Loading trending GIFs...</div>
            </div>
          </div>
          
          <!-- Reply indicator -->
          <div id="replyIndicator" style="display:none; background: rgba(125, 211, 252, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 8px; margin-bottom: 8px; font-size: 12px;">
            <span id="replyText"></span>
            <button id="cancelReply" style="float: right; background: var(--danger); color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 10px;">✕</button>
          </div>
          
          <div class="row" style="position: relative;">
            <input id="messageInput" type="text" placeholder="Type a message and press Enter…" maxlength="500" />
            <button id="imageBtn" class="btn-icon" title="Upload Image">📷</button>
            <button id="emojiBtn" class="btn-icon" title="Add Emoji">😀</button>
            <button id="gifBtn" class="btn-icon" title="Send GIF">🎬</button>
            <button id="sendBtn">Send</button>
            
            <!-- Emoji Panel -->
            <div id="emojiPanel" style="display:none;">
              <input class="emoji-search" id="emojiSearch" placeholder="Search emojis..." />
              <div class="emoji-grid" id="emojiGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <div class="section">
          <label>Voice Chat</label>
          <div class="vc-controls">
            <button id="joinVcBtn" class="success">🎤 Join Voice Chat</button>
            <div class="vc-buttons" id="vcButtons" style="display: none;">
              <button id="muteBtn" class="btn-icon" title="Mute/Unmute">🎤</button>
              <button id="deafenBtn" class="btn-icon" title="Deafen">🔊</button>
              <button id="settingsBtn" class="btn-icon" title="Settings">⚙️</button>
              <button id="leaveVcBtn" class="danger btn-icon" title="Leave VC">📞</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="participantsCard" style="display: none;">
        <div class="section">
          <label>Voice Participants (<span id="participantCount">0</span>)</label>
          <div class="vc-participants" id="participantsList"></div>
        </div>
      </div>

      <div class="card" id="settingsCard" style="display: none;">
        <div class="section">
          <label>Audio Settings</label>
          <div class="stack">
            <div>
              <label for="micSelect">Microphone</label>
              <select id="micSelect">
                <option>Default</option>
              </select>
            </div>
            <div>
              <label for="volumeSlider">Volume: <span id="volumeValue">100%</span></label>
              <input type="range" id="volumeSlider" min="0" max="100" value="100" />
            </div>
            <button id="testMicBtn">Test Microphone</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section">
          <label>Chat Features</label>
          <div class="stack">
            <div>
              <label for="autoScroll">Auto-scroll to bottom</label>
              <input type="checkbox" id="autoScroll" checked />
            </div>
            <div>
              <label for="soundNotifications">Sound notifications</label>
              <input type="checkbox" id="soundNotifications" />
            </div>
            <div>
              <label for="compactMode">Compact message view</label>
              <input type="checkbox" id="compactMode" />
            </div>
            <div>
              <label for="messageLimit">Messages to load: <span id="messageLimitValue">200</span></label>
              <input type="range" id="messageLimit" min="50" max="500" step="50" value="200" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      Built with Firebase Realtime Database · Discord Integration Active · Be nice, stay cozy ✨
    </footer>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, push, serverTimestamp, onChildAdded, limitToLast, query, orderByChild, onValue, set, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
    
    // Your config
    const firebaseConfig = {
      apiKey: "AIzaSyAUhiB3d042QEfM5qWdC5qYGt7hrcqKolc",
      authDomain: "chatting-6cd81.firebaseapp.com",
      databaseURL: "https://chatting-6cd81-default-rtdb.firebaseio.com",
      projectId: "chatting-6cd81",
      storageBucket: "chatting-6cd81.firebasestorage.app",
      messagingSenderId: "584471983807",
      appId: "1:584471983807:web:b71eb2ba2a071d311b380a",
      measurementId: "G-53H0MM5V6M"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // CHANGE THIS PASSWORD TO WHATEVER YOU WANT
    const CHAT_PASSWORD = "plebous123ous";
    
    // GIF API
    const GIPHY_KEY = "bDiYI9SyxC1DGIdqZe3ZdbnFsOHJGlBm";
    
    // Discord Integration Server URL - CHANGE THIS TO YOUR SERVER URL
    const DISCORD_SERVER_URL = "https://plebious-github-io.onrender.com";

    // Emoji data
    const EMOJIS = [
      '😀','😃','😄','😁','😆','😅','🤣','😂','🙂','🙃','😉','😊','😇','🥰','😍','🤩','😘','😗','☺️','😚','😙','🥲','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','😒','🙄','😬','🤥','😌','😔','😪','🤤','😴','😷','🤒','🤕','🤢','🤮','🤧','🥵','🥶','🥴','😵','🤯','🤠','🥳','🥸','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','😠','🤬','😈','👿','💀','☠️','💩','🤡','👹','👺','👻','👽','👾','🤖',
      '🐶','🐱','🐭','🐹','🐰','🦊','🐻','🐼','🐨','🐯','🦁','🐮','🐷','🐽','🐸','🐵','🙈','🙉','🙊','🐒','🐔','🐧','🐦','🐤','🐣','🐥','🦆','🦅','🦉','🦇','🐺','🐗','🐴','🦄','🐝','🐛','🦋','🐌','🐞','🐜','🦟','🦗','🕷️','🕸️','🦂','🐢','🐍','🦎','🦖','🦕','🐙','🦑','🦐','🦞','🦀','🐡','🐠','🐟','🐬','🐳','🐋','🦈','🐅','🐆','🦓','🦏','🦛','🐘',
      '🍏','🍎','🍐','🍊','🍋','🍌','🍉','🍇','🍓','🫐','🍈','🍒','🍑','🥭','🍍','🥥','🥝','🍅','🍆','🥑','🥦','🥬','🥒','🌶️','🫑','🌽','🥕','🫒','🧄','🧅','🥔','🍠','🥐','🥯','🍞','🥖','🥨','🧀','🥚','🍳','🧈','🥞','🧇','🥓','🥩','🍗','🍖','🦴','🌭','🍔','🍟','🍕','🫓','🥪','🥙','🧆','🌮','🌯','🫔','🥗','🥘','🫕','🥫','🍝','🍜','🍲','🍛','🍣','🍱','🥟','🦪','🍤','🍙','🍚','🍘','🍥','🥠','🥮','🍢','🍡','🍧','🍨','🍦','🥧','🧁','🍰','🎂','🍮','🍭','🍬','🍫','🍿','🍩','🍪',
      '⚽','🏀','🏈','⚾','🥎','🎾','🏐','🏉','🥏','🎱','🪀','🏓','🏸','🏒','🏑','🥍','🏏','🪃','🥅','⛳','🪁','🏹','🎣','🤿','🥽','🎽','🥋','🎿','🛷','🥌','🎯','🪀','🪁','🎪','🤹','🎨','🎬','🎤','🎧','🎼','🎵','🎶','🥇','🥈','🥉','🏆','🏅','🎖️','🏵️','🎗️','🎫','🎟️','🎪','🤹','🎭','🩰','🎨','🎬','🎤','🎧','🎼','🎵','🎶','🎙️','📻','🎷','🪗','🎸','🎹','🎺','🎻','🪕','🥁','🪘',
      '🚗','🚕','🚙','🚌','🚎','🏎️','🚓','🚑','🚒','🚐','🛻','🚚','🚛','🚜','🏍️','🛵','🚲','🛴','🛹','🛼','🚁','✈️','🛩️','🛫','🛬','🪂','💺','🚀','🛸','🚉','🚊','🚝','🚞','🚋','🚃','🚋','🚞','🚝','🚄','🚅','🚈','🚂','🚆','🚇','🚊','🚉','✈️','🛫','🛬','🛩️','🚁','🚟','🚠','🚡','🛰️','🚀','🛸','🛶','⛵','🚤','🛥️','🛳️','⛴️','🚢','⚓','⛽','🚧','🚨','🚥','🚦','🛑','🚏',
      '⌚','📱','📲','💻','⌨️','🖥️','🖨️','🖱️','🖲️','🕹️','💽','💾','💿','📀','📼','📷','📸','📹','🎥','📽️','🎞️','📞','☎️','📟','📠','📺','📻','🎙️','🎚️','🎛️','🧭','⏱️','⏲️','⏰','🕰️','⌛','⏳','📡','🔋','🔌','💡','🔦','🕯️','🪔','🧯','🛢️','💸','💵','💴','💶','💷','🪙','💰','💳','💎','⚖️','🪜','🧰','🔧','🔨','⚒️','🛠️','⛏️','🔩','⚙️','🪚','🔫','🧲','💣','🧨','🪓','🔪','🗡️','⚔️','🛡️',
      '❤️','🧡','💛','💚','💙','💜','🖤','🤍','🤎','💔','❣️','💕','💞','💓','💗','💖','💘','💝','💟','☮️','✝️','☪️','🕉️','☸️','✡️','🔯','🕎','☯️','☦️','🛐','⛎','♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓','🆔','⚛️','🉑','☢️','☣️','📴','📳','🈶','🈚️','🈸','🈺','🈷️','✴️','🆚','💮','🉐','㊙️','㊗️','🈴','🈵','🈹','🈲','🅰️','🅱️','🆎','🆑','🅾️','🆘','❌','⭕','🛑','⛔','📛','🚫','💯','💢','♨️','🚷','🚯','🚳','🚱','🔞','📵','🚭','❗','❕','❓','❔','‼️','⁉️','🔅','🔆','〽️','⚠️','🚸','🔱','⚜️','🔰','♻️','✅','🈯️','💹','❇️','✳️','❎','🌐','💠','Ⓜ️','🌀','💤','🏧','🚾','♿','🅿️','🛗','🈳','🈂️','🛂','🛃','🛄','🛅','🚹','🚺','🚼','⚧️','🚻','🚮','🎦','📶','🈁','🔣','ℹ️','🔤','🔡','🔠','🆖','🆗','🆙','🆒','🆕','🆓','0️⃣','1️⃣','2️⃣','3️⃣','4️⃣','5️⃣','6️⃣','7️⃣','8️⃣','9️⃣','🔟','🔢','#️⃣','*️⃣','⏏️','▶️','⏸️','⏯️','⏹️','⏺️','⏭️','⏮️','⏩','⏪','⏫','⏬','◀️','🔼','🔽','➡️','⬅️','⬆️','⬇️','↗️','↘️','↙️','↖️','↕️','↔️','↪️','↩️','⤴️','⤵️','🔀','🔁','🔂','🔄','🔃','🎵','🎶','➕','➖','➗','✖️','♾️','💲','💱','™️','©️','®️','〰️','➰','➿','🔚','🔙','🔛','🔝','🔜','✔️','☑️','🔘','🔴','🟠','🟡','🟢','🔵','🟣','⚫','⚪','🟤','🔺','🔻','🔸','🔹','🔶','🔷','🔳','🔲','▪️','▫️','◾','◽','◼️','◻️','🟥','🟧','🟨','🟩','🟦','🟪','⬛','⬜','🟫'
    ];

    // DOM Elements
    const verificationScreen = document.getElementById('verificationScreen');
    const mainApp = document.getElementById('mainApp');
    const passwordInput = document.getElementById('passwordInput');
    const displayNameInput = document.getElementById('displayNameInput');
    const enterChatBtn = document.getElementById('enterChatBtn');
    const errorMessage = document.getElementById('errorMessage');
    
    const nameInput = document.getElementById('displayName');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const resetBtn = document.getElementById('clearBtn');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const listEl = document.getElementById('messages');
    const connEl = document.getElementById('conn');
    const discordStatusEl = document.getElementById('discordStatus');
    const imageInput = document.getElementById('imageInput');
    const imageBtn = document.getElementById('imageBtn');
    const uploadArea = document.getElementById('uploadArea');
    const typingIndicator = document.getElementById('typingIndicator');
    const onlineUsersEl = document.getElementById('onlineUsers');
    
    // New feature elements
    const searchMessages = document.getElementById('searchMessages');
    const searchBtn = document.getElementById('searchBtn');
    const replyIndicator = document.getElementById('replyIndicator');
    const replyText = document.getElementById('replyText');
    const cancelReply = document.getElementById('cancelReply');
    const scrollToBottom = document.getElementById('scrollToBottom');
    const darkBtn = document.getElementById('darkBtn');
    const lightBtn = document.getElementById('lightBtn');
    const autoScroll = document.getElementById('autoScroll');
    const soundNotifications = document.getElementById('soundNotifications');
    const compactMode = document.getElementById('compactMode');
    const messageLimit = document.getElementById('messageLimit');
    const messageLimitValue = document.getElementById('messageLimitValue');
    
    // GIF Elements
    const gifBtn = document.getElementById('gifBtn');
    const gifPanel = document.getElementById('gifPanel');
    const gifSearchInput = document.getElementById('gifSearchInput');
    const gifSearchBtn = document.getElementById('gifSearchBtn');
    const gifResults = document.getElementById('gifResults');
    
    // Emoji Elements
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const emojiSearch = document.getElementById('emojiSearch');
    const emojiGrid = document.getElementById('emojiGrid');
    
    // Voice Chat Elements
    const joinVcBtn = document.getElementById('joinVcBtn');
    const vcButtons = document.getElementById('vcButtons');
    const muteBtn = document.getElementById('muteBtn');
    const deafenBtn = document.getElementById('deafenBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const leaveVcBtn = document.getElementById('leaveVcBtn');
    const participantsCard = document.getElementById('participantsCard');
    const participantsList = document.getElementById('participantsList');
    const participantCount = document.getElementById('participantCount');
    const settingsCard = document.getElementById('settingsCard');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const testMicBtn = document.getElementById('testMicBtn');

    // App State
    let inVoiceChat = false;
    let isMuted = false;
    let isDeafened = false;
    let mediaStream = null;
    let userId = Math.random().toString(36).substr(2, 9);
    let typingTimeout;
    let isTyping = false;
    let discordConnected = false;
    let currentReply = null;
    let allMessages = [];
    let isSearching = false;
    let currentTheme = localStorage.getItem('pleb_theme') || 'dark';
    let currentMessageLimit = parseInt(localStorage.getItem('pleb_message_limit')) || 200;

    // Helpers
    const STORAGE_KEY = 'pleb_chat_name';
    const VERIFIED_KEY = 'pleb_chat_verified';
    const messagesRef = ref(db, 'messages');
    const presenceRef = ref(db, '.info/connected');
    const voiceParticipantsRef = ref(db, 'voice_participants');
    const userVoiceRef = ref(db, `voice_participants/${userId}`);
    const kickedUsersRef = ref(db, 'kicked_users');
    const typingRef = ref(db, 'typing');
    const userTypingRef = ref(db, `typing/${userId}`);
    const onlineUsersRef = ref(db, 'online_users');
    const userOnlineRef = ref(db, `online_users/${userId}`);

    // Initialize theme
    document.documentElement.setAttribute('data-theme', currentTheme);
    if (currentTheme === 'light') {
      lightBtn.classList.add('active');
      darkBtn.classList.remove('active');
    }

    // Initialize message limit
    messageLimit.value = currentMessageLimit;
    messageLimitValue.textContent = currentMessageLimit;

    // Notification sound
    function playNotificationSound() {
      if (!soundNotifications.checked) return;
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTuX4PU');
        audio.volume = 0.1;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    // Emoji Functions
    function renderEmojis() {
      emojiGrid.innerHTML = '';
      
      const searchTerm = emojiSearch.value.toLowerCase();
      const filteredEmojis = searchTerm ? 
        EMOJIS.filter(() => true) : // Simple filter for now
        EMOJIS;

      filteredEmojis.slice(0, 200).forEach(emoji => {
        const emojiEl = document.createElement('div');
        emojiEl.className = 'emoji-item';
        emojiEl.textContent = emoji;
        emojiEl.title = emoji;
        emojiEl.onclick = (e) => {
          if (e.shiftKey) {
            navigator.clipboard?.writeText(emoji);
            flashStatus('Copied ' + emoji);
          } else {
            const cursorPos = msgInput.selectionStart;
            const textBefore = msgInput.value.substring(0, cursorPos);
            const textAfter = msgInput.value.substring(msgInput.selectionEnd);
            msgInput.value = textBefore + emoji + textAfter;
            msgInput.focus();
            msgInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            toggleEmojiPanel();
          }
        };
        emojiGrid.appendChild(emojiEl);
      });
    }

    function toggleEmojiPanel() {
      const isVisible = emojiPanel.style.display !== 'none';
      emojiPanel.style.display = isVisible ? 'none' : 'block';
      emojiBtn.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        renderEmojis();
        setTimeout(() => emojiSearch.focus(), 100);
      }
    }

    // Theme Functions
    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('pleb_theme', theme);
      
      if (theme === 'dark') {
        darkBtn.classList.add('active');
        lightBtn.classList.remove('active');
      } else {
        lightBtn.classList.add('active');
        darkBtn.classList.remove('active');
      }
    }

    // Message Search Functions
    function searchInMessages(query) {
      if (!query.trim()) {
        showSearchResults([]);
        return;
      }

      const results = allMessages.filter(msg => 
        msg.text && msg.text.toLowerCase().includes(query.toLowerCase()) ||
        msg.name && msg.name.toLowerCase().includes(query.toLowerCase())
      );
      
      showSearchResults(results);
    }

    function showSearchResults(results) {
      if (results.length === 0 && !searchMessages.value.trim()) {
        hideSearchResults();
        return;
      }

      isSearching = true;
      const searchDiv = document.createElement('div');
      searchDiv.className = 'search-results';
      searchDiv.id = 'searchResults';

      const header = document.createElement('div');
      header.className = 'search-header';
      header.innerHTML = `
        <span>Found ${results.length} message${results.length !== 1 ? 's' : ''}</span>
        <button class="close-search" onclick="window.hideSearchResults()">✕</button>
      `;

      searchDiv.appendChild(header);

      results.forEach(msg => {
        const el = msgElement(msg);
        searchDiv.appendChild(el);
      });

      const existingResults = document.getElementById('searchResults');
      if (existingResults) {
        existingResults.remove();
      }

      listEl.appendChild(searchDiv);
    }

    function hideSearchResults() {
      isSearching = false;
      const existingResults = document.getElementById('searchResults');
      if (existingResults) {
        existingResults.remove();
      }
    }

    // Global function for search results
    window.hideSearchResults = hideSearchResults;

    // Reply Functions
    function setReply(msgData) {
      currentReply = msgData;
      replyText.textContent = `Replying to ${msgData.name}: ${(msgData.text || 'Image').substring(0, 50)}${msgData.text && msgData.text.length > 50 ? '...' : ''}`;
      replyIndicator.style.display = 'block';
      msgInput.focus();
    }

    function cancelReplyFn() {
      currentReply = null;
      replyIndicator.style.display = 'none';
    }

    // Auto-scroll Functions
    function checkScrollPosition() {
      const isNearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 100;
      scrollToBottom.classList.toggle('hidden', isNearBottom || isSearching);
    }

    function scrollToBottomFn() {
      listEl.scrollTop = listEl.scrollHeight;
      scrollToBottom.classList.add('hidden');
    }

    // Online Users Functions
    function updateOnlineUsers(users) {
      const count = Object.keys(users || {}).length;
      if (count > 0) {
        onlineUsersEl.textContent = `${count} online`;
        onlineUsersEl.style.display = 'block';
      } else {
        onlineUsersEl.style.display = 'none';
      }
    }

    // Discord Integration Functions
    async function sendToDiscord(name, text, imageData = null) {
      if (!discordConnected) return;
      
      try {
        const response = await fetch(`${DISCORD_SERVER_URL}/send-to-discord`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name,
            text: text,
            imageData: imageData
          })
        });
        
        if (response.ok) {
          console.log('Message sent to Discord successfully');
        } else {
          console.error('Failed to send message to Discord');
        }
      } catch (error) {
        console.error('Error sending to Discord:', error);
        setDiscordStatus(false);
      }
    }

    async function checkDiscordConnection() {
      try {
        const response = await fetch(`${DISCORD_SERVER_URL}/health`);
        if (response.ok) {
          const data = await response.json();
          setDiscordStatus(data.discord === true);
          return data.discord === true;
        }
      } catch (error) {
        console.error('Discord server connection error:', error);
      }
      setDiscordStatus(false);
      return false;
    }

    function setDiscordStatus(connected) {
      discordConnected = connected;
      discordStatusEl.style.display = connected ? 'block' : 'none';
      discordStatusEl.textContent = connected ? 'Discord Connected' : 'Discord Offline';
      discordStatusEl.className = connected ? 'discord-status' : 'status';
    }

    // Password Verification
    function checkPassword() {
      const password = passwordInput.value.trim();
      const name = displayNameInput.value.trim();
      
      if (!password) {
        showError('Please enter the password');
        return;
      }
      
      if (!name) {
        showError('Please enter a display name');
        return;
      }
      
      if (password === CHAT_PASSWORD) {
        localStorage.setItem(VERIFIED_KEY, 'true');
        localStorage.setItem(STORAGE_KEY, name);
        
        verificationScreen.style.display = 'none';
        mainApp.style.display = 'grid';
        nameInput.value = name;
        
        initializeMainApp();
      } else {
        showError('Incorrect password. Try again.');
        passwordInput.value = '';
        passwordInput.focus();
      }
    }

    function showError(message) {
      errorMessage.textContent = '❌ ' + message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }

    function checkExistingVerification() {
      const isVerified = localStorage.getItem(VERIFIED_KEY);
      const savedName = localStorage.getItem(STORAGE_KEY);
      
      if (isVerified === 'true' && savedName) {
        verificationScreen.style.display = 'none';
        mainApp.style.display = 'grid';
        nameInput.value = savedName;
        initializeMainApp();
      } else {
        passwordInput.focus();
      }
    }

    function saveName() {
      const val = (nameInput.value || '').trim();
      if (!val) return alert('Enter a display name first.');
      localStorage.setItem(STORAGE_KEY, val);
      flashStatus('Saved!');
      nameInput.blur();
    }

    function getName() {
      return (localStorage.getItem(STORAGE_KEY) || '').trim();
    }

    function flashStatus(text) {
      connEl.textContent = text;
      setTimeout(() => updateConnBadge(), 1200);
    }

    function updateConnBadge(connected) {
      if (typeof connected === 'boolean') {
        connEl.textContent = connected ? '● Online' : '● Offline';
        return;
      }
      connEl.textContent = connEl.textContent.includes('●') ? connEl.textContent : '● Online';
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        const now = new Date();
        const sameDay = d.toDateString() === now.toDateString();
        return sameDay ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : d.toLocaleString();
      } catch (_) { return '…'; }
    }

    function msgElement({ name, text, timestamp, imageData, isAdmin, isDiscord, discordAvatar, replyTo }) {
      const me = getName();
      const root = document.createElement('div');
      root.className = 'msg' + (name === me ? ' you' : '') + (isAdmin ? ' msg-admin' : '') + (isDiscord ? ' msg-discord' : '') + (compactMode.checked ? ' compact' : '');

      // Reply button
      const replyBtn = document.createElement('button');
      replyBtn.className = 'msg-reply-button';
      replyBtn.textContent = '↩️';
      replyBtn.title = 'Reply';
      replyBtn.onclick = () => setReply({ name, text, timestamp });
      root.appendChild(replyBtn);

      // Reply indicator
      if (replyTo) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'msg-reply-to';
        replyDiv.textContent = `↩️ ${replyTo.name}: ${(replyTo.text || 'Image').substring(0, 30)}${replyTo.text && replyTo.text.length > 30 ? '...' : ''}`;
        root.appendChild(replyDiv);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';

      const nameEl = document.createElement('span');
      nameEl.className = 'name' + (isAdmin ? ' name-admin' : '') + (isDiscord ? ' name-discord' : '');
      nameEl.textContent = name || 'anon';
      nameEl.onclick = () => {
        msgInput.value = '@' + name + ' ' + msgInput.value;
        msgInput.focus();
      };

      const dot = document.createElement('span');
      dot.textContent = '•';

      const timeEl = document.createElement('span');
      timeEl.className = 'time';
      timeEl.textContent = timestamp ? formatTime(timestamp) : 'sending…';

      meta.append(nameEl, dot, timeEl);

      if (isDiscord) {
        const discordIndicator = document.createElement('span');
        discordIndicator.className = 'discord-indicator';
        discordIndicator.textContent = 'Discord';
        meta.appendChild(document.createElement('span'));
        meta.appendChild(discordIndicator);
      }

      root.appendChild(meta);

      if (text) {
        const textEl = document.createElement('div');
        textEl.className = isAdmin ? 'text-admin' : isDiscord ? 'text-discord' : '';
        
        // Simple mention highlighting
        let processedText = text;
        if (text.includes('@' + me)) {
          processedText = text.replace(new RegExp('@' + me, 'gi'), `<span style="background: rgba(125, 211, 252, 0.2); color: var(--accent); font-weight: bold;">@${me}</span>`);
          if (name !== me) playNotificationSound();
        }
        
        textEl.innerHTML = processedText;
        root.appendChild(textEl);
      }

      if (imageData) {
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'msg-image';
        img.onclick = () => window.open(imageData, '_blank');
        root.appendChild(img);
      }

      return root;
    }

    function appendAndScroll(el) {
      if (isSearching) return;
      
      listEl.appendChild(el);
      if (autoScroll.checked) {
        const nearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 80;
        if (nearBottom) listEl.scrollTop = listEl.scrollHeight;
      }
      checkScrollPosition();
    }

    // Typing indicator functions
    function setTyping(typing) {
      const name = getName();
      if (!name) return;
      
      if (typing && !isTyping) {
        isTyping = true;
        set(userTypingRef, name).catch(err => console.error('Typing set error:', err));
      } else if (!typing && isTyping) {
        isTyping = false;
        remove(userTypingRef).catch(err => console.error('Typing remove error:', err));
      }
    }

    function handleTypingInput() {
      const name = getName();
      if (!name) return;

      if (msgInput.value.length > 0) {
        setTyping(true);
      }

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        setTyping(false);
      }, 2000);
    }

    // GIF Functions
    async function fetchGifs(endpoint) {
      gifResults.innerHTML = '<div class="gif-loading">Loading GIFs...</div>';
      
      try {
        const response = await fetch(endpoint);
        const data = await response.json();
        
        gifResults.innerHTML = '';
        
        if (!data.data || data.data.length === 0) {
          gifResults.innerHTML = '<div class="gif-empty">No GIFs found. Try a different search term.</div>';
          return;
        }
        
        data.data.forEach(gif => {
          const img = document.createElement('img');
          img.src = gif.images.fixed_width_small.url;
          img.className = 'gif-item';
          img.alt = gif.title || 'GIF';
          img.onclick = () => {
            sendMessage(gif.images.original.url);
            toggleGifPanel();
          };
          gifResults.appendChild(img);
        });
      } catch (error) {
        console.error('Error fetching GIFs:', error);
        gifResults.innerHTML = '<div class="gif-error">Failed to load GIFs. Please try again.</div>';
      }
    }

    function loadTrendingGifs() {
      fetchGifs(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_KEY}&limit=24&rating=pg`);
    }

    function searchGifs() {
      const query = gifSearchInput.value.trim();
      if (!query) {
        loadTrendingGifs();
        return;
      }
      fetchGifs(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(query)}&limit=24&rating=pg`);
    }

    function toggleGifPanel() {
      const isVisible = gifPanel.style.display !== 'none';
      gifPanel.style.display = isVisible ? 'none' : 'block';
      gifBtn.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        loadTrendingGifs();
        gifSearchInput.focus();
      }
    }

    async function sendMessage(imageData = null) {
      const name = getName();
      const text = (msgInput.value || '').trim();
      if (!name) return alert('Set your display name first!');
      if (!text && !imageData) return;
      
      try {
        const kickedSnapshot = await new Promise((resolve) => {
          onValue(ref(db, `kicked_users/${name}`), resolve, { onlyOnce: true });
        });
        
        if (kickedSnapshot.exists()) {
          alert('You have been kicked from the chat and cannot send messages.');
          msgInput.disabled = true;
          sendBtn.disabled = true;
          msgInput.placeholder = "You have been kicked from the chat";
          return;
        }
      } catch (error) {
        console.log('Could not check kick status, allowing message');
      }
      
      msgInput.value = '';
      setTyping(false);
      msgInput.focus();

      try {
        const messageData = {
          name,
          timestamp: serverTimestamp(),
        };
        
        if (text) messageData.text = text;
        if (imageData) messageData.imageData = imageData;
        if (currentReply) {
          messageData.replyTo = {
            name: currentReply.name,
            text: currentReply.text
          };
        }
        
        await push(messagesRef, messageData);
        
        if (discordConnected) {
          let discordText = text;
          if (currentReply) {
            discordText = `[Reply to ${currentReply.name}]: ${text}`;
          }
          await sendToDiscord(name, discordText, imageData);
        }

        cancelReplyFn();
      } catch (e) {
        console.error(e);
        alert('Failed to send. Check connection.');
      }
    }

    function handleImageUpload(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/') && file.size < 5 * 1024 * 1024) {
          const reader = new FileReader();
          reader.onload = (e) => sendMessage(e.target.result);
          reader.readAsDataURL(file);
        } else {
          alert('Please select images under 5MB only.');
        }
      });
    }

    // Voice Chat Functions
    async function joinVoiceChat() {
      const name = getName();
      if (!name) return alert('Set your display name first!');
      
      try {
        const kickedSnapshot = await new Promise((resolve) => {
          onValue(ref(db, `kicked_users/${name}`), resolve, { onlyOnce: true });
        });
        
        if (kickedSnapshot.exists()) {
          alert('You have been kicked from the chat and cannot join voice chat.');
          return;
        }
      } catch (error) {
        console.log('Could not check kick status, allowing voice chat');
      }
      
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        inVoiceChat = true;
        
        joinVcBtn.style.display = 'none';
        vcButtons.style.display = 'grid';
        participantsCard.style.display = 'block';
        
        await set(userVoiceRef, {
          name: name,
          muted: false,
          joinedAt: serverTimestamp()
        });
        
        onDisconnect(userVoiceRef).remove();
        
        flashStatus('Joined voice chat!');
      } catch (error) {
        console.error('Error joining voice chat:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }

    async function leaveVoiceChat() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      
      await remove(userVoiceRef);
      
      inVoiceChat = false;
      isMuted = false;
      isDeafened = false;
      
      joinVcBtn.style.display = 'block';
      vcButtons.style.display = 'none';
      participantsCard.style.display = 'none';
      settingsCard.style.display = 'none';
      muteBtn.textContent = '🎤';
      deafenBtn.textContent = '🔊';
      muteBtn.classList.remove('active');
      deafenBtn.classList.remove('active');
      
      flashStatus('Left voice chat');
    }

    function toggleMute() {
      if (!inVoiceChat) return;
      
      isMuted = !isMuted;
      muteBtn.textContent = isMuted ? '🔇' : '🎤';
      muteBtn.classList.toggle('active', isMuted);
      
      if (mediaStream) {
        mediaStream.getAudioTracks().forEach(track => {
          track.enabled = !isMuted;
        });
      }
      
      set(ref(db, `voice_participants/${userId}/muted`), isMuted);
    }

    function toggleDeafen() {
      isDeafened = !isDeafened;
      deafenBtn.textContent = isDeafened ? '🔇' : '🔊';
      deafenBtn.classList.toggle('active', isDeafened);
      
      if (isDeafened && !isMuted) {
        toggleMute();
      }
    }

    function toggleSettings() {
      const isVisible = settingsCard.style.display !== 'none';
      settingsCard.style.display = isVisible ? 'none' : 'block';
    }

    function updateParticipants(participants) {
      participantsList.innerHTML = '';
      const count = Object.keys(participants).length;
      participantCount.textContent = count;
      
      Object.entries(participants).forEach(([id, data]) => {
        const div = document.createElement('div');
        div.className = 'participant';
        
        const indicator = document.createElement('div');
        indicator.className = 'speaking-indicator';
        indicator.style.visibility = data.muted ? 'hidden' : 'visible';
        
        const name = document.createElement('span');
        name.textContent = data.name || 'Anonymous';
        
        div.appendChild(indicator);
        div.appendChild(name);
        participantsList.appendChild(div);
      });
    }

    function initializeMainApp() {
      checkDiscordConnection();
      setInterval(checkDiscordConnection, 30000);
      
      onValue(presenceRef, (snap) => {
        const connected = !!snap.val();
        updateConnBadge(connected);
      });

      const name = getName();
      if (name) {
        set(userOnlineRef, { name, lastSeen: serverTimestamp() });
        onDisconnect(userOnlineRef).remove();
        
        onValue(onlineUsersRef, (snap) => {
          updateOnlineUsers(snap.val());
        });
      }

      const recent = query(messagesRef, orderByChild('timestamp'), limitToLast(currentMessageLimit));
      onChildAdded(recent, (snap) => {
        const v = snap.val() || {};
        const ts = typeof v.timestamp === 'number' ? v.timestamp : Date.now();
        const msgData = { 
          name: v.name, 
          text: v.text, 
          timestamp: ts,
          imageData: v.imageData,
          isAdmin: v.isAdmin || false,
          isDiscord: v.isDiscord || false,
          discordAvatar: v.discordAvatar,
          replyTo: v.replyTo
        };
        
        allMessages.push(msgData);
        if (allMessages.length > currentMessageLimit * 2) {
          allMessages = allMessages.slice(-currentMessageLimit);
        }
        
        appendAndScroll(msgElement(msgData));
        
        if (v.name !== name && !isSearching) {
          playNotificationSound();
        }
      });

      onValue(typingRef, (snapshot) => {
        updateTypingIndicator(snapshot.val());
      });

      onValue(voiceParticipantsRef, (snap) => {
        const participants = snap.val() || {};
        if (inVoiceChat) {
          updateParticipants(participants);
        }
      });

      if (name) {
        try {
          onValue(ref(db, `kicked_users/${name}`), (snapshot) => {
            if (snapshot.exists()) {
              alert('You have been kicked from the chat by an administrator.');
              
              msgInput.disabled = true;
              sendBtn.disabled = true;
              imageBtn.disabled = true;
              gifBtn.disabled = true;
              emojiBtn.disabled = true;
              msgInput.placeholder = "You have been kicked from the chat";
              msgInput.style.backgroundColor = '#2d1b1b';
              
              setTyping(false);
              
              if (inVoiceChat) {
                leaveVoiceChat();
              }
              
              joinVcBtn.disabled = true;
              joinVcBtn.textContent = '❌ Kicked from Chat';
              joinVcBtn.classList.add('danger');
              
              if (gifPanel.style.display !== 'none') {
                toggleGifPanel();
              }
              if (emojiPanel.style.display !== 'none') {
                toggleEmojiPanel();
              }
              
              flashStatus('❌ Kicked');
            } else {
              if (msgInput.disabled) {
                msgInput.disabled = false;
                sendBtn.disabled = false;
                imageBtn.disabled = false;
                gifBtn.disabled = false;
                emojiBtn.disabled = false;
                msgInput.placeholder = "Type a message and press Enter…";
                msgInput.style.backgroundColor = '';
                
                joinVcBtn.disabled = false;
                joinVcBtn.textContent = '🎤 Join Voice Chat';
                joinVcBtn.classList.remove('danger');
                joinVcBtn.classList.add('success');
                
                flashStatus('✅ Access Restored');
              }
            }
          });
        } catch (error) {
          console.error('Error monitoring kick status:', error);
        }
      }

      onDisconnect(userTypingRef).remove();
    }

    // Event Listeners
    enterChatBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkPassword();
    });
    displayNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkPassword();
    });

    saveNameBtn.addEventListener('click', saveName);
    resetBtn.addEventListener('click', () => {
      localStorage.clear();
      location.reload();
    });
    
    sendBtn.addEventListener('click', () => sendMessage());
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Typing events
    msgInput.addEventListener('input', handleTypingInput);
    msgInput.addEventListener('focus', handleTypingInput);
    msgInput.addEventListener('blur', () => setTyping(false));

    // Search events
    searchBtn.addEventListener('click', () => searchInMessages(searchMessages.value));
    searchMessages.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchInMessages(searchMessages.value);
    });
    searchMessages.addEventListener('input', () => {
      if (!searchMessages.value.trim()) hideSearchResults();
    });

    // Reply events
    cancelReply.addEventListener('click', cancelReplyFn);

    // Theme events
    darkBtn.addEventListener('click', () => setTheme('dark'));
    lightBtn.addEventListener('click', () => setTheme('light'));

    // Settings events
    messageLimit.addEventListener('input', (e) => {
      currentMessageLimit = parseInt(e.target.value);
      messageLimitValue.textContent = currentMessageLimit;
      localStorage.setItem('pleb_message_limit', currentMessageLimit);
    });

    compactMode.addEventListener('change', () => {
      document.querySelectorAll('.msg').forEach(msg => {
        msg.classList.toggle('compact', compactMode.checked);
      });
    });

    // Scroll events
    listEl.addEventListener('scroll', checkScrollPosition);
    scrollToBottom.addEventListener('click', scrollToBottomFn);

    // Image Upload Events
    imageBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', (e) => handleImageUpload(e.target.files));
    uploadArea.addEventListener('click', () => imageInput.click());
    
    // Drag and Drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleImageUpload(e.dataTransfer.files);
    });

    // Emoji Events
    emojiBtn.addEventListener('click', toggleEmojiPanel);
    emojiSearch.addEventListener('input', renderEmojis);
    emojiSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') toggleEmojiPanel();
    });

    // Close panels when clicking outside
    document.addEventListener('click', (e) => {
      if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
        if (emojiPanel.style.display !== 'none') {
          toggleEmojiPanel();
        }
      }
      if (!gifPanel.contains(e.target) && !gifBtn.contains(e.target)) {
        if (gifPanel.style.display !== 'none') {
          toggleGifPanel();
        }
      }
    });

    // GIF Events
    gifBtn.addEventListener('click', toggleGifPanel);
    gifSearchBtn.addEventListener('click', searchGifs);
    gifSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchGifs();
    });

    // Voice Chat Events
    joinVcBtn.addEventListener('click', joinVoiceChat);
    leaveVcBtn.addEventListener('click', leaveVoiceChat);
    muteBtn.addEventListener('click', toggleMute);
    deafenBtn.addEventListener('click', toggleDeafen);
    settingsBtn.addEventListener('click', toggleSettings);
    
    volumeSlider.addEventListener('input', (e) => {
      volumeValue.textContent = e.target.value + '%';
    });
    
    testMicBtn.addEventListener('click', () => {
      if (mediaStream) {
        flashStatus('Microphone working!');
      } else {
        alert('Join voice chat first to test microphone.');
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchMessages.focus();
      }
      
      if (e.key === 'Escape') {
        if (emojiPanel.style.display !== 'none') toggleEmojiPanel();
        if (gifPanel.style.display !== 'none') toggleGifPanel();
        hideSearchResults();
        cancelReplyFn();
      }
      
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && msgInput.value.trim()) {
        sendMessage();
      }
    });

    // Load saved preferences
    const savedAutoScroll = localStorage.getItem('pleb_auto_scroll');
    if (savedAutoScroll !== null) autoScroll.checked = savedAutoScroll === 'true';
    
    const savedSoundNotifications = localStorage.getItem('pleb_sound_notifications');
    if (savedSoundNotifications !== null) soundNotifications.checked = savedSoundNotifications === 'true';
    
    const savedCompactMode = localStorage.getItem('pleb_compact_mode');
    if (savedCompactMode !== null) compactMode.checked = savedCompactMode === 'true';

    // Save preferences when changed
    autoScroll.addEventListener('change', () => {
      localStorage.setItem('pleb_auto_scroll', autoScroll.checked);
    });
    
    soundNotifications.addEventListener('change', () => {
      localStorage.setItem('pleb_sound_notifications', soundNotifications.checked);
    });
    
    compactMode.addEventListener('change', () => {
      localStorage.setItem('pleb_compact_mode', compactMode.checked);
      document.querySelectorAll('.msg').forEach(msg => {
        msg.classList.toggle('compact', compactMode.checked);
      });
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (inVoiceChat) {
        leaveVoiceChat();
      }
      setTyping(false);
    });

    // Error handling
    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e.reason);
      if (!e.reason?.message?.includes('network') && !e.reason?.message?.includes('fetch')) {
        flashStatus('⚠️ Connection issue');
      }
    });

    // Periodic cleanup
    setInterval(() => {
      if (allMessages.length > currentMessageLimit * 3) {
        allMessages = allMessages.slice(-currentMessageLimit);
        console.log('Cleaned up old messages from memory');
      }
    }, 300000);

    // Console welcome message
    console.log(`
    Pleb Chat ENCHATED
    
    New Features:
    - 😀 Emoji picker with 500+ emojis
    - 🔍 Real-time message search  
    - ↩️ Reply to messages
    - 🎨 Light/Dark themes
    - ⚙️ Customizable settings
    - 🔊 Sound notifications
    - 📱 Mobile responsive
    
    Keyboard shortcuts:
    - Ctrl+K: Focus search
    - Ctrl+Enter: Send message  
    - Escape: Close panels
    
    Built with Firebase + Discord integration
    `);

    // Initialize the app
    checkExistingVerification();

    // --- Cooldown Feature ---
    let lastMessageTime = 0;
    const COOLDOWN = 7000; // 7 seconds

    async function sendMessage(imageData = null) {
      const now = Date.now();
      if (now - lastMessageTime < COOLDOWN) {
        alert(`Please wait ${Math.ceil((COOLDOWN - (now - lastMessageTime)) / 1000)}s before sending another message.`);
        return;
      }

      const name = getName();
      const text = (msgInput.value || '').trim();
      if (!name) return alert('Set your display name first!');
      if (!text && !imageData) return;

      try {
        // Check if kicked
        const kickedSnapshot = await new Promise((resolve) => {
          onValue(ref(db, `kicked_users/${name}`), resolve, { onlyOnce: true });
        });

        if (kickedSnapshot.exists()) {
          alert('You have been kicked from the chat and cannot send messages.');
          msgInput.disabled = true;
          sendBtn.disabled = true;
          msgInput.placeholder = "You have been kicked from the chat";
          return;
        }
      } catch (error) {
        console.log('Could not check kick status, allowing message');
      }

      msgInput.value = '';
      setTyping(false);
      msgInput.focus();

      try {
        const messageData = { name, timestamp: serverTimestamp() };
        if (text) messageData.text = text;
        if (imageData) messageData.imageData = imageData;
        if (currentReply) {
          messageData.replyTo = { name: currentReply.name, text: currentReply.text };
        }

        await push(messagesRef, messageData);

        if (discordConnected) {
          let discordText = text;
          if (currentReply) {
            discordText = `[Reply to ${currentReply.name}]: ${text}`;
          }
          await sendToDiscord(name, discordText, imageData);
        }

        lastMessageTime = now;
        cancelReplyFn();
      } catch (e) {
        console.error(e);
        alert('Failed to send. Check connection.');
      }
    }

    // (rest of script unchanged, with all resetBtn references removed)
  </script>
</body>
</html>


// ////////////////////////////////////


